// ============================================================================
// PRISMA SCHEMA - ACADEMIA HUB (BASE DE VÉRITÉ COMPLÈTE)
// ============================================================================
// 
// Schéma structurant pour Academia Hub
// Couvre : tenant / année / niveau / track / finance / audit / TOUS LES MODULES
// 
// RÈGLES FONDAMENTALES :
// - Toute table métier DOIT contenir tenantId + academicYearId + schoolLevelId
// - academicTrackId est optionnel (nullable pour compatibilité FR par défaut)
// - ORION = SELECT ONLY (rôle academia_orion)
// - API = seule porte d'entrée (rôle academia_app)
// ============================================================================

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// CORE - TENANT & CONTEXT
// ============================================================================

model Tenant {
  id                String   @id @default(uuid())
  name              String
  subdomain         String?  @unique
  slug              String   @unique
  schemaName        String?
  countryId         String
  type              String   @default("SCHOOL") // SCHOOL | PATRONAT
  subscriptionStatus String  @default("TRIAL") // TRIAL, ACTIVE_SUBSCRIBED, EXPIRED, SUSPENDED
  status            String   @default("active")
  subscriptionPlan  String   @default("free")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  trialEndsAt       DateTime?
  nextPaymentDueAt  DateTime?

  // Relations
  country           Country  @relation(fields: [countryId], references: [id], onDelete: Restrict)
  academicYears     AcademicYear[]
  feeDefinitions    FeeDefinition[]
  studentFees       StudentFee[]
  paymentSummaries  PaymentSummary[]
  dailyClosures     DailyClosure[]
  feeArrears        FeeArrear[]
  schoolLevels      SchoolLevel[]
  feeDefinitions    FeeDefinition[]
  studentFees       StudentFee[]
  paymentSummaries  PaymentSummary[]
  dailyClosures     DailyClosure[]
  feeArrears        FeeArrear[]
  academicTracks   AcademicTrack[]
  students          Student[]
  users             User[]
  schools           School[]
  studentIdentifiers StudentIdentifier[]
  studentIdCards     StudentIdCard[]
  publicVerificationTokens PublicVerificationToken[]
  tenantFeatures    TenantFeature[]
  paymentFlows      PaymentFlow[]
  auditLogs         AuditLog[]
  // Module Paramètres
  schoolSettings    SchoolSettings?
  securitySettings  SecuritySettings?
  offlineSyncSettings OfflineSyncSettings?
  orionSettings     OrionSettings?
  atlasSettings     AtlasSettings?
  settingsHistory   SettingsHistory[]
  // Module Réunions
  meetings          Meeting[]
  meetingMinutesTemplates MeetingMinutesTemplate[]
  // Module 9 - Modules Complémentaires
  canteenEnrollments CanteenEnrollment[]
  transportAssignments TransportAssignment[]
  transportIncidents TransportIncident[]
  vehicles Vehicle[]
  routes Route[]
  libraryBooks LibraryBook[]
  labs Lab[]
  medicalRecords MedicalRecord[]
  medications Medication[]
  shopProducts ShopProduct[]
  shopSales ShopSale[]
  educastContents EducastContent[]
  tuitionPayments   TuitionPayment[]
  payments          Payment[]
  subjects          Subject[]
  exams             Exam[]
  grades            Grade[]
  classes           Class[]
  feeDefinitions    FeeDefinition[]
  teachers          Teacher[]
  absences          Absence[]
  discipline        Discipline[]
  expenses          Expense[]
  feeConfigurations FeeConfiguration[]
  rooms             Room[]
  departments       Department[]
  quarters          Quarter[]
  roles             Role[]
  messages          Message[]
  communicationChannels CommunicationChannel[]
  messageTemplates  MessageTemplate[]
  automatedTriggers AutomatedTrigger[]
  messageLogs       MessageLog[]
  announcements     Announcement[]
  schoolPaymentAccounts SchoolPaymentAccount[]
  modules           Module[]
  dataExports       DataExport[]
  dataConsents      DataConsent[]
  tenantDomains     TenantDomain[]
  tenantSettings    TenantSetting[]
  subscriptions    Subscription[]
  subscriptionInvoices SubscriptionInvoice[]
  guardians         Guardian[]
  studentGuardians  StudentGuardian[]
  studentEnrollments StudentEnrollment[]
  studentFees       StudentFee[]
  paymentSummaries  PaymentSummary[]
  feeArrears        FeeArrear[]
  admissions       Admission[]
  transferRequests TransferRequest[]
  classStudents    ClassStudent[]
  classTransfers   ClassTransfer[]
  disciplinaryActions DisciplinaryAction[]
  studentDocuments StudentDocument[]
  documentTemplates DocumentTemplate[]
  generatedDocuments GeneratedDocument[]
  tuitionInstallments TuitionInstallment[]
  discounts        Discount[]
  paymentPlans     PaymentPlan[]
  expenseCategories ExpenseCategory[]
  cashClosures     CashClosure[]
  treasuryMovements TreasuryMovement[]
  staff            Staff[]
  staffDocuments   StaffDocument[]
  staffAssignments StaffAssignment[]
  contracts        Contract[]
  contractTemplates ContractTemplate[]
  staffAttendance  StaffAttendance[]
  staffEvaluations StaffEvaluation[]
  staffTrainings   StaffTraining[]
  overtimeRecords OvertimeRecord[]
  trainingSessions TrainingSession[]
  payrolls         Payroll[]
  payrollItems     PayrollItem[]
  salaryPayments   SalaryPayment[]
  salarySlips      SalarySlip[]
  employeeCNSS     EmployeeCNSS[]
  cnssDeclarations CNSSDeclaration[]
  teacherSubjects  TeacherSubject[]
  classSubjects    ClassSubject[]
  teacherClassAssignments TeacherClassAssignment[]
  timeSlots        TimeSlot[]
  dailyLogs        DailyLog[]
  classDiaries     ClassDiary[]
  roomAllocations  RoomAllocation[]
  roomReservations RoomReservation[]
  subjectAssignments SubjectAssignment[]
  timetables       Timetable[]
  timetableEntries TimetableEntry[]
  timetableVersions TimetableVersion[]
  pedagogicalSheets PedagogicalSheet[]
  pedagogicalSheetVersions PedagogicalSheetVersion[]
  pedagogicalSheetValidations PedagogicalSheetValidation[]
  lessonJournals   LessonJournal[]
  lessonJournalEntries LessonJournalEntry[]
  lessonJournalValidations LessonJournalValidation[]
  lessonPlans     LessonPlan[]
  pedagogicalDocuments PedagogicalDocument[]
  pedagogicalDocumentVersions PedagogicalDocumentVersion[]
  pedagogicalDocumentReviews PedagogicalDocumentReview[]
  pedagogicalDocumentComments PedagogicalDocumentComment[]
  pedagogicalDocumentNotifications PedagogicalDocumentNotification[]
  weeklyDutyAssignments WeeklyDutyAssignment[]
  weeklySemainiers WeeklySemainier[]
  lessonPlanAssignments LessonPlanAssignment[]
  homeworkEntries HomeworkEntry[]
  homeworkSubmissions HomeworkSubmission[]
  examSessions    ExamSession[]
  examSubjects    ExamSubject[]
  examScores      ExamScore[]
  gradeCalculations GradeCalculation[]
  gradeRulesVersions GradeRulesVersion[]
  reportCards     ReportCard[]
  reportCardItems ReportCardItem[]
  rankings        Ranking[]
  honorRolls      HonorRoll[]
  classCouncils   ClassCouncil[]
  councilDecisions CouncilDecision[]
  councilMinutes  CouncilMinute[]
  messageRecipients MessageRecipient[]
  messageTemplates MessageTemplate[]
  smsLogs         SmsLog[]
  emailLogs       EmailLog[]
  whatsappLogs    WhatsappLog[]
  pushNotifications PushNotification[]
  communicationStats CommunicationStat[]
  libraryBooks    LibraryBook[]
  libraryLoans    LibraryLoan[]
  labEquipment    LabEquipment[]
  labReservations LabReservation[]
  vehicles        Vehicle[]
  routes          Route[]
  transportAssignments TransportAssignment[]
  canteenMenus    CanteenMenu[]
  canteenSubscriptions CanteenSubscription[]
  canteenPayments CanteenPayment[]
  medicalRecords MedicalRecord[]
  medicalVisits  MedicalVisit[]
  medications   Medication[]
  inspections   Inspection[]
  incidents     Incident[]
  correctiveActions CorrectiveAction[]
  products       Product[]
  orders         Order[]
  orderItems     OrderItem[]
  storePayments  StorePayment[]
  mediaContents  MediaContent[]
  mediaSessions  MediaSession[]
  mediaViews     MediaView[]
  kpiDefinitions KpiDefinition[]
  kpiSnapshots   KpiSnapshot[]
  orionAlerts    OrionAlert[]
  orionReports   OrionReport[]
  atlasConversations AtlasConversation[]
  atlasMessages  AtlasMessage[]
  atlasFeedback  AtlasFeedback[]
  syncOperations SyncOperation[]
  syncConflicts  SyncConflict[]
  syncLogs       SyncLog[]
  activityLogs   ActivityLog[]
  // Module Patronat & Examens
  patronat        Patronat?
  patronatUsers  PatronatUser[]
  patronatSchools PatronatSchool[] @relation("PatronatSchools")
  patronatSchoolCreators PatronatSchool[] @relation("PatronatSchoolCreator")
  patronatSchoolSuspenders PatronatSchool[] @relation("PatronatSchoolSuspender")
  examCandidateSchoolTenants ExamCandidate[] @relation("ExamCandidateSchoolTenant")
  resourceAccessSchoolTenants ResourceAccessLog[] @relation("ResourceAccessSchoolTenant")
  nationalExams  NationalExam[]
  examCenters    ExamCenter[]
  examCandidates ExamCandidate[]
  examRooms      ExamRoom[]
  examSupervisors ExamSupervisor[]
  nationalExamSubjects NationalExamSubject[]
  examResults    ExamResult[]
  examDocuments  ExamDocument[]
  questionBankResources QuestionBankResource[]
  resourceAccessLogs ResourceAccessLog[]
  // Module 7 - QHSE, Incidents & Conformité
  incidents            Incident[]
  inspections          Inspection[]
  complianceRequirements ComplianceRequirement[]
  complianceRecords    ComplianceRecord[]
  riskAlerts           RiskAlert[]
  // Module 8 - ORION
  kpiDefinitions       KpiDefinition[]
  kpiSnapshots         KpiSnapshot[]
  orionAlerts          OrionAlert[]
  orionInsights        OrionInsight[]
  orionAuditLogs       OrionAuditLog[]
  orionReports         OrionReport[]

  @@index([subdomain])
  @@index([slug])
  @@index([countryId])
  @@map("tenants")
}

model Country {
  id            String   @id @default(uuid())
  code          String   @unique // ISO 3166-1 alpha-2 (ex: 'BJ')
  name          String
  code3         String?
  numericCode   String?
  currencyCode  String?
  currencySymbol String?
  phonePrefix   String?
  flagEmoji     String?
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenants       Tenant[]
  gradingPolicies GradingPolicy[]
  salaryPolicies SalaryPolicy[]

  @@map("countries")
}

model AcademicYear {
  id            String    @id @default(uuid())
  tenantId      String
  name          String
  label         String
  preEntryDate  DateTime? // Date de prérentrée (lundi 2ème semaine septembre)
  startDate     DateTime  // Date de rentrée officielle (lundi suivant prérentrée)
  endDate       DateTime  // Date de fin d'année (fin juin ou 1ère semaine juillet)
  isActive      Boolean   @default(false)
  isAutoGenerated Boolean @default(false) // Indique si générée automatiquement
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  students Student[]
  tuitionPayments TuitionPayment[]
  subjects Subject[]
  exams    Exam[]
  grades   Grade[]
  classes  Class[]
  teachers Teacher[]
  quarters Quarter[]
  feeConfigurations FeeConfiguration[]
  studentEnrollments StudentEnrollment[]
  admissions Admission[]
  transferRequests TransferRequest[]
  payments Payment[]
  expenses Expense[]
  roomReservations RoomReservation[]
  roomAllocations RoomAllocation[]
  subjectAssignments SubjectAssignment[]
  timetables Timetable[]
  timetableEntries TimetableEntry[]
  timetableVersions TimetableVersion[]
  pedagogicalSheets PedagogicalSheet[]
  pedagogicalSheetVersions PedagogicalSheetVersion[]
  pedagogicalSheetValidations PedagogicalSheetValidation[]
  lessonJournals LessonJournal[]
  lessonJournalEntries LessonJournalEntry[]
  lessonJournalValidations LessonJournalValidation[]
  lessonPlans LessonPlan[]
  lessonPlanAssignments LessonPlanAssignment[]
  homeworkEntries HomeworkEntry[]
  examSessions ExamSession[]
  examSubjects ExamSubject[]
  examScores ExamScore[]
  gradeCalculations GradeCalculation[]
  gradeRulesVersions GradeRulesVersion[]
  reportCards ReportCard[]
  rankings Ranking[]
  honorRolls HonorRoll[]
  classCouncils ClassCouncil[]
  libraryLoans LibraryLoan[]
  labReservations LabReservation[]
  routes Route[]
  canteenMenus CanteenMenu[]
  canteenSubscriptions CanteenSubscription[]
  canteenPayments CanteenPayment[]
  medicalRecords MedicalRecord[]
  medicalVisits MedicalVisit[]
  medications Medication[]
  incidents Incident[]
  orders Order[]
  orderItems OrderItem[]
  storePayments StorePayment[]
  mediaSessions MediaSession[]
  mediaViews MediaView[]
  kpiDefinitions KpiDefinition[]
  kpiSnapshots KpiSnapshot[]
  orionAlerts OrionAlert[]
  orionReports OrionReport[]
  atlasConversations AtlasConversation[]
  atlasMessages AtlasMessage[]
  atlasFeedback AtlasFeedback[]
  communicationStats CommunicationStat[]
  activityLogs ActivityLog[]
  staff Staff[]
  staffDocuments StaffDocument[]
  staffAssignments StaffAssignment[]
  contracts Contract[]
  trainingSessions TrainingSession[]
  payrolls Payroll[]
  payrollItems PayrollItem[]
  salaryPayments SalaryPayment[]
  // Module 9 - Modules Complémentaires (existants)
  libraryBooks LibraryBook[]
  labEquipment LabEquipment[]
  vehicles Vehicle[]
  products Product[]
  mediaContents MediaContent[]
  // Module 9 - Nouvelles relations
  canteenEnrollments CanteenEnrollment[]
  transportAssignments TransportAssignment[]
  transportIncidents TransportIncident[]
  libraryLoans LibraryLoan[]
  labs Lab[]
  medicalRecords MedicalRecord[]
  medications Medication[]
  shopProducts ShopProduct[]
  // Module 1 - Vérification publique & Dossier scolaire
  publicVerificationTokens PublicVerificationToken[]
  studentAcademicRecords StudentAcademicRecord[] @relation("StudentAcademicRecordAcademicYear")
  studentDisciplinarySummaries StudentDisciplinarySummary[] @relation("StudentDisciplinarySummaryAcademicYear")
  // Module 4 - Recouvrement
  collectionCases CollectionCase[] @relation("CollectionCaseAcademicYear")
  shopSales ShopSale[]
  educastContents EducastContent[]
  inspections Inspection[]
  correctiveActions CorrectiveAction[]
  discounts Discount[]
  paymentPlans PaymentPlan[]
  expenseCategories ExpenseCategory[]
  cashClosures CashClosure[]
  treasuryMovements TreasuryMovement[]
  messages       Message[]
  automatedTriggers AutomatedTrigger[]
  // Module 7 - QHSE, Incidents & Conformité
  incidents            Incident[]
  inspections          Inspection[]
  complianceRecords    ComplianceRecord[]
  riskAlerts           RiskAlert[]
  // Module 8 - ORION
  kpiDefinitions       KpiDefinition[]
  kpiSnapshots         KpiSnapshot[]
  orionAlerts          OrionAlert[]
  orionInsights        OrionInsight[]
  orionReports         OrionReport[]

  @@unique([tenantId, name])
  @@unique([tenantId, label])
  @@index([tenantId, isActive])
  @@map("academic_years")
}

model SchoolLevel {
  id       String   @id @default(uuid())
  tenantId String
  code     String   // MATERNELLE, PRIMAIRE, SECONDAIRE
  name     String
  label    String
  order    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  students Student[]
  tuitionPayments TuitionPayment[]
  subjects Subject[]
  exams    Exam[]
  grades   Grade[]
  classes  Class[]
  teachers Teacher[]
  absences Absence[]
  discipline Discipline[]
  rooms    Room[]
  expenses Expense[]
  questionBankResources QuestionBankResource[] @relation("QuestionBankSchoolLevel")
  feeConfigurations FeeConfiguration[]
  announcements Announcement[]
  modules  Module[]
  payments Payment[]
  studentEnrollments StudentEnrollment[]
  admissions Admission[]
  transferRequests TransferRequest[]
  classStudents ClassStudent[]
  classTransfers ClassTransfer[]
  attendanceRecords AttendanceRecord[]
  disciplineRecords DisciplineRecord[]
  disciplinaryActions DisciplinaryAction[]
  studentDocuments StudentDocument[]
  generatedDocuments GeneratedDocument[]
  roomReservations RoomReservation[]
  subjectAssignments SubjectAssignment[]
  timetables Timetable[]
  timetableEntries TimetableEntry[]
  timetableVersions TimetableVersion[]
  pedagogicalSheets PedagogicalSheet[]
  pedagogicalSheetVersions PedagogicalSheetVersion[]
  pedagogicalSheetValidations PedagogicalSheetValidation[]
  lessonJournals LessonJournal[]
  lessonJournalEntries LessonJournalEntry[]
  lessonJournalValidations LessonJournalValidation[]
  lessonPlans LessonPlan[]
  lessonPlanAssignments LessonPlanAssignment[]
  homeworkEntries HomeworkEntry[]
  homeworkSubmissions HomeworkSubmission[]
  examSessions ExamSession[]
  examSubjects ExamSubject[]
  examScores ExamScore[]
  gradeCalculations GradeCalculation[]
  gradeRulesVersions GradeRulesVersion[]
  reportCards ReportCard[]
  reportCardItems ReportCardItem[]
  rankings Ranking[]
  honorRolls HonorRoll[]
  classCouncils ClassCouncil[]
  libraryLoans LibraryLoan[]
  labReservations LabReservation[]
  routes Route[]
  transportAssignments TransportAssignment[]
  canteenMenus CanteenMenu[]
  canteenSubscriptions CanteenSubscription[]
  canteenPayments CanteenPayment[]
  medicalRecords MedicalRecord[]
  medicalVisits MedicalVisit[]
  medications Medication[]
  incidents Incident[]
  orders Order[]
  orderItems OrderItem[]
  storePayments StorePayment[]
  mediaSessions MediaSession[]
  mediaViews MediaView[]
  kpiDefinitions KpiDefinition[]
  kpiSnapshots KpiSnapshot[]
  orionAlerts OrionAlert[]
  orionReports OrionReport[]
  atlasConversations AtlasConversation[]
  atlasMessages AtlasMessage[]
  atlasFeedback AtlasFeedback[]
  communicationStats CommunicationStat[]
  activityLogs ActivityLog[]
  staff Staff[]
  staffDocuments StaffDocument[]
  staffAssignments StaffAssignment[]
  staffAttendance StaffAttendance[]
  staffEvaluations StaffEvaluation[]
  contracts Contract[]
  trainingSessions TrainingSession[]
  payrolls Payroll[]
  payrollItems PayrollItem[]
  salaryPayments SalaryPayment[]
  discounts Discount[]
  paymentPlans PaymentPlan[]
  expenseCategories ExpenseCategory[]
  cashClosures CashClosure[]
  treasuryMovements TreasuryMovement[]
  inspections Inspection[]
  correctiveActions CorrectiveAction[]
  products Product[]
  mediaContents MediaContent[]
  messages       Message[]
  automatedTriggers AutomatedTrigger[]
  // Module 7 - QHSE, Incidents & Conformité
  incidents            Incident[]
  inspections          Inspection[]
  complianceRecords    ComplianceRecord[]
  riskAlerts           RiskAlert[]
  // Module 8 - ORION
  kpiDefinitions       KpiDefinition[]
  kpiSnapshots         KpiSnapshot[]
  orionAlerts          OrionAlert[]
  orionInsights        OrionInsight[]
  orionReports         OrionReport[]
  // Module Réunions
  meetings Meeting[] @relation("MeetingSchoolLevel")
  canteenEnrollments CanteenEnrollment[] @relation("CanteenEnrollmentSchoolLevel")
  educastContents EducastContent[] @relation("EducastContentSchoolLevel")
  educastAccesses EducastAccess[] @relation("EducastAccessSchoolLevel")
  studentAcademicRecords StudentAcademicRecord[] @relation("StudentAcademicRecordSchoolLevel")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("school_levels")
}

model AcademicTrack {
  id          String   @id @default(uuid())
  tenantId    String
  code        String   // FR, EN
  name        String
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subjects Subject[]
  exams    Exam[]
  grades   Grade[]
  classes  Class[]
  studentAcademicTracks StudentAcademicTrack[]
  pedagogicalSheets PedagogicalSheet[]
  lessonJournals LessonJournal[]
  // Module Réunions
  meetings Meeting[] @relation("MeetingStudent")
  canteenEnrollments CanteenEnrollment[]
  transportAssignments TransportAssignment[]
  libraryLoans LibraryLoan[]
  educastAccesses EducastAccess[]
  educastSessions EducastSession[]
  medicalRecords MedicalRecord[]
  lessonPlans LessonPlan[]
  homeworkEntries HomeworkEntry[]
  examSessions ExamSession[]
  examScores ExamScore[]
  gradeCalculations GradeCalculation[]
  reportCards ReportCard[]
  rankings Ranking[]
  honorRolls HonorRoll[]
  classCouncils ClassCouncil[]

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@map("academic_tracks")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id        String   @id @default(uuid())
  tenantId  String?
  email     String   @unique
  passwordHash String?
  firstName String?
  lastName  String?
  role      String?  // SUPER_DIRECTOR, DIRECTOR, TEACHER, ACCOUNTANT, ADMIN, STUDENT, PARENT
  isSuperAdmin Boolean @default(false)
  status    String   @default("active")
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schools School[]
  userRoles UserRole[]
  createdAbsences Absence[] @relation("AbsenceCreator")
  justifiedAbsences Absence[] @relation("AbsenceJustifier")
  createdDiscipline Discipline[] @relation("DisciplineCreator")
  reportedDiscipline Discipline[] @relation("DisciplineReporter")
  createdPayments Payment[]
  createdExpenses Expense[]
  approvedExpenses Expense[] @relation("ExpenseApprover")
  createdFeeConfigurations FeeConfiguration[]
  createdFeeDefinitions FeeDefinition[]
  issuedReceipts PaymentReceipt[] @relation("PaymentReceiptIssuer")
  validatedClosures DailyClosure[] @relation("DailyClosureValidator")
  createdClosures DailyClosure[] @relation("DailyClosureCreator")
  createdPaymentPromises PaymentPromise[] @relation("PaymentPromiseCreator")
  performedCollectionActions CollectionAction[] @relation("CollectionActionPerformer")
  staffEvaluations StaffEvaluation[] @relation("StaffEvaluator")
  validatedFeeProfiles StudentFeeProfile[] @relation("StudentFeeProfileValidator")
  validatedOvertime OvertimeRecord[] @relation("OvertimeValidator")
  issuedSalarySlips SalarySlip[] @relation("SalarySlipIssuer")
  createdRooms Room[]
  createdDepartments Department[]
  createdQuarters Quarter[]
  createdTeachers Teacher[]
  sentMessages Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")
  createdAnnouncements Announcement[]
  createdSchoolPaymentAccounts SchoolPaymentAccount[] @relation("SchoolPaymentAccountCreator")
  verifiedSchoolPaymentAccounts SchoolPaymentAccount[] @relation("SchoolPaymentAccountVerifier")
  createdDataExports DataExport[]
  dataConsents DataConsent[]
  sessions Session[]
  passwordResets PasswordReset[]
  atlasConversations AtlasConversation[]
  activityLogs ActivityLog[]
  // Module Patronat & Examens
  patronatUsers PatronatUser[]
  patronatSchoolCreators PatronatSchool[] @relation("PatronatSchoolCreator")
  patronatSchoolSuspenders PatronatSchool[] @relation("PatronatSchoolSuspender")
  nationalExamCreators NationalExam[] @relation("NationalExamCreator")
  examCenterCreators ExamCenter[] @relation("ExamCenterCreator")
  examCandidateCreators ExamCandidate[] @relation("ExamCandidateCreator")
  examRoomCreators ExamRoom[] @relation("ExamRoomCreator")
  examSupervisorCreators ExamSupervisor[] @relation("ExamSupervisorCreator")
  examSupervisorUsers ExamSupervisor[] @relation("ExamSupervisorUser")
  nationalExamSubjectCreators NationalExamSubject[] @relation("NationalExamSubjectCreator")
  validatedExamScores ExamScore[] @relation("ExamScoreValidator")
  examResultEnterers ExamResult[] @relation("ExamResultEnterer")
  examResultValidators ExamResult[] @relation("ExamResultValidator")
  examDocumentGenerators ExamDocument[] @relation("ExamDocumentGenerator")
  examDocumentPublishers ExamDocument[] @relation("ExamDocumentPublisher")
  questionBankUploaders QuestionBankResource[] @relation("QuestionBankUploader")
  resourceAccessUsers ResourceAccessLog[] @relation("ResourceAccessUser")
  patronatUserCreators PatronatUser[] @relation("PatronatUserCreator")
  // Module 7 - QHSE, Incidents & Conformité
  reportedIncidents Incident[] @relation("IncidentReportedBy")
  closedIncidents Incident[] @relation("IncidentClosedBy")
  incidentActions IncidentAction[] @relation("IncidentActionResponsible")
  validatedComplianceRecords ComplianceRecord[] @relation("ComplianceRecordValidator")
  acknowledgedRiskAlerts RiskAlert[] @relation("RiskAlertAcknowledgedBy")
  // Module 2 - Système de Workflow Pédagogique
  validatedPedagogicalDocuments PedagogicalDocument[] @relation("PedagogicalDocumentValidator")
  acknowledgedPedagogicalDocuments PedagogicalDocument[] @relation("PedagogicalDocumentAcknowledger")
  pedagogicalDocumentVersionCreators PedagogicalDocumentVersion[]
  pedagogicalDocumentReviewers PedagogicalDocumentReview[] @relation("PedagogicalDocumentReviewer")
  pedagogicalDocumentCommentAuthors PedagogicalDocumentComment[] @relation("PedagogicalDocumentCommentAuthor")
  pedagogicalDocumentNotificationRecipients PedagogicalDocumentNotification[] @relation("PedagogicalDocumentNotificationRecipient")
  weeklyDutyAssigners WeeklyDutyAssignment[]
  weeklySemainierValidators WeeklySemainier[] @relation("WeeklySemainierValidator")
  weeklySemainierIncidentReporters WeeklySemainierIncident[] @relation("WeeklySemainierIncidentReporter")
  // Module 1 - Matricule Global & Cartes Scolaires
  generatedStudentIdentifiers StudentIdentifier[] @relation("StudentIdentifierGenerator")
  generatedStudentIdCards StudentIdCard[] @relation("StudentIdCardGenerator")
  revokedStudentIdCards StudentIdCard[] @relation("StudentIdCardRevoker")
  // Module 8 - ORION
  acknowledgedOrionAlerts OrionAlert[] @relation("OrionAlertAcknowledgedBy")
  orionAuditLogs OrionAuditLog[] @relation("OrionAuditLogUser")
  // Module Paramètres
  settingsHistory SettingsHistory[] @relation("SettingsHistoryUser")
  enabledFeatures TenantFeature[] @relation("TenantFeatureEnabledBy")
  disabledFeatures TenantFeature[] @relation("TenantFeatureDisabledBy")
  // Module Réunions
  createdMeetings Meeting[] @relation("MeetingCreator")
  cancelledMeetings Meeting[] @relation("MeetingCancelledBy")
  meetingParticipants MeetingParticipant[] @relation("MeetingParticipantInviter")
  meetingAgendaPresenters MeetingAgenda[] @relation("MeetingAgendaPresenter")
  meetingMinutesRecorders MeetingMinutes[] @relation("MeetingMinutesRecorder")
  meetingMinutesValidators MeetingMinutes[] @relation("MeetingMinutesValidator")
  meetingMinutesVersionModifiers MeetingMinutesVersion[] @relation("MeetingMinutesVersionModifier")
  meetingMinutesVersionValidators MeetingMinutesVersion[] @relation("MeetingMinutesVersionValidator")
  electronicSignatures ElectronicSignature[] @relation("ElectronicSignatureUser")
  meetingDecisionResponsibles MeetingDecision[] @relation("MeetingDecisionResponsible")
  meetingAttachmentUploaders MeetingAttachment[] @relation("MeetingAttachmentUploader")
  // Module 9 - Modules Complémentaires
  canteenAttendanceRecorders CanteenAttendance[] @relation("CanteenAttendanceRecorder")
  transportAttendanceRecorders TransportAttendance[] @relation("TransportAttendanceRecorder")
  transportIncidentReporters TransportIncident[] @relation("TransportIncidentReporter")
  libraryLoanLoaners LibraryLoan[] @relation("LibraryLoanLoaner")
  libraryLoanReturners LibraryLoan[] @relation("LibraryLoanReturner")
  labReservationUsers LabReservation[] @relation("LabReservationUser")
  labIncidentReporters LabIncident[] @relation("LabIncidentReporter")
  medicalVisitPerformers MedicalVisit[] @relation("MedicalVisitPerformer")
  medicalAlertAcknowledgers MedicalAlert[] @relation("MedicalAlertAcknowledger")
  shopSaleSellers ShopSale[] @relation("ShopSaleSeller")
  educastContentUploaders EducastContent[] @relation("EducastContentUploader")
  educastAccessGranters EducastAccess[] @relation("EducastAccessGranter")

  @@index([tenantId, role])
  @@index([email])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String?
  name        String
  description String?
  isSystemRole Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles   UserRole[]
  rolePermissions RolePermission[]

  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================================================
// SCHOOLS
// ============================================================================

model School {
  id              String   @id @default(uuid())
  tenantId        String   @unique
  name            String
  abbreviation    String?
  educationLevels String[]
  motto           String?
  slogan          String?
  address         String?
  primaryPhone    String?
  secondaryPhone  String?
  primaryEmail    String?
  website         String?
  whatsapp        String?
  logo            String?
  primaryColor    String   @default("#3b82f6")
  secondaryColor  String   @default("#10b981")
  founderName     String?
  directorPrimary String?
  directorSecondary String?
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator User? @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@map("schools")
}

// ============================================================================
// STUDENTS & ACADEMICS
// ============================================================================

model Student {
  id                    String   @id @default(uuid())
  tenantId              String
  academicYearId        String
  currentAcademicYearId String?  // Année scolaire courante (pour navigation rapide)
  schoolLevelId         String
  studentCode           String?  // Identifiant unique interne (ex: STU-2024-001)
  firstName             String
  lastName              String
  dateOfBirth           DateTime?
  gender                String?
  nationality           String?
  primaryLanguage       String?  // FR | EN (pour support bilingue)
  status                String   @default("ACTIVE") // ACTIVE, INACTIVE, GRADUATED, TRANSFERRED, ARCHIVED
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  tuitionPayments TuitionPayment[]
  payments     Payment[]
  grades       Grade[]
  absences     Absence[]
  discipline   Discipline[]
  studentAcademicTracks StudentAcademicTrack[]
  studentGuardians StudentGuardian[]
  studentEnrollments StudentEnrollment[]
  classStudents ClassStudent[]
  studentDocuments StudentDocument[]
  disciplinaryActions DisciplinaryAction[]
  examScores ExamScore[]
  reportCards ReportCard[]
  rankings Ranking[]
  honorRolls HonorRoll[]
  councilDecisions CouncilDecision[]
  homeworkSubmissions HomeworkSubmission[]
  transportAssignments TransportAssignment[]
  canteenSubscriptions CanteenSubscription[]
  medicalRecords MedicalRecord[]
  studentFees       StudentFee[]
  paymentSummaries  PaymentSummary[]
  feeArrears        FeeArrear[]
  studentArrears    StudentArrear[]
  feeProfiles       StudentFeeProfile[]
  medicalVisits MedicalVisit[]
  medications Medication[]
  orders Order[]
  mediaSessions MediaSession[]
  incidents Incident[]
  identifier        StudentIdentifier?
  idCards           StudentIdCard[]
  publicVerificationTokens PublicVerificationToken[] @relation("PublicVerificationTokenStudent")
  academicRecords   StudentAcademicRecord[] @relation("StudentAcademicRecordStudent")
  disciplinarySummaries StudentDisciplinarySummary[] @relation("StudentDisciplinarySummaryStudent")
  collectionCases   CollectionCase[] @relation("StudentCollectionCase")

  @@unique([tenantId, studentCode])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([tenantId, status])
  @@index([tenantId, studentCode])
  @@map("students")
}

model StudentAcademicTrack {
  id             String   @id @default(uuid())
  studentId      String
  academicTrackId String
  enrollmentDate DateTime?
  exitDate       DateTime?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  student       Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  academicTrack AcademicTrack @relation(fields: [academicTrackId], references: [id], onDelete: Cascade)

  @@unique([studentId, academicTrackId])
  @@map("student_academic_tracks")
}

model Class {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  name           String
  code           String
  capacity       Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear  AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel   SchoolLevel   @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  absences      Absence[]
  feeConfigurations FeeConfiguration[]
  announcements Announcement[]
  classStudents ClassStudent[]
  classTransfersFrom ClassTransfer[] @relation("ClassTransfersFrom")
  classTransfersTo ClassTransfer[] @relation("ClassTransfersTo")
  classCouncils ClassCouncil[]
  studentEnrollments StudentEnrollment[]
  attendanceRecords AttendanceRecord[]
  subjectAssignments SubjectAssignment[]
  timetableEntries TimetableEntry[]
  pedagogicalSheets PedagogicalSheet[]
  lessonJournals LessonJournal[]
  lessonPlans LessonPlan[]
  lessonPlanAssignments LessonPlanAssignment[]
  homeworkEntries HomeworkEntry[]
  examSubjects ExamSubject[]
  rankings Ranking[]
  honorRolls HonorRoll[]
  staffAssignments StaffAssignment[]
  classSubjects ClassSubject[]
  dailyLogs DailyLog[]
  incidents Incident[]
  // Module Réunions
  meetings Meeting[] @relation("MeetingClass")
  canteenEnrollments CanteenEnrollment[] @relation("CanteenEnrollmentClass")
  educastContents EducastContent[] @relation("EducastContentClass")
  educastAccesses EducastAccess[] @relation("EducastAccessClass")
  studentAcademicRecords StudentAcademicRecord[] @relation("StudentAcademicRecordClass")

  @@unique([tenantId, academicYearId, code])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("classes")
}

model Subject {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  name           String
  code           String
  coefficient    Float    @default(1.0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear  AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel   SchoolLevel   @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  exams         Exam[]
  grades        Grade[]
  teachers      Teacher[]
  assignments   SubjectAssignment[]
  timetableEntries TimetableEntry[]
  examSubjects ExamSubject[]
  examScores ExamScore[]
  gradeCalculations GradeCalculation[]
  reportCardItems ReportCardItem[]
  pedagogicalSheets PedagogicalSheet[]
  lessonJournals LessonJournal[]
  lessonPlans LessonPlan[]
  homeworkEntries HomeworkEntry[]

  @@unique([tenantId, academicYearId, schoolLevelId, code])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("subjects")
}

model Exam {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  examSessionId  String?
  quarterId      String?  // Période d'examen (trimestre/semestre)
  classSubjectId String?  // Lien avec ClassSubject (Module 2)
  subjectId      String
  classId        String?
  name           String
  examType       String   @default("COMPOSITION") // DEVOIR | COMPOSITION | ORAL | PRATIQUE
  examDate       DateTime
  maxScore       Float    @default(20.0)
  coefficient    Float    @default(1.0)
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear  AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel   SchoolLevel   @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  examSession   ExamSession?   @relation(fields: [examSessionId], references: [id], onDelete: SetNull)
  quarter       Quarter?       @relation(fields: [quarterId], references: [id], onDelete: SetNull)
  classSubject  ClassSubject?  @relation(fields: [classSubjectId], references: [id], onDelete: SetNull)
  subject       Subject       @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  grades        Grade[]
  examSubjects  ExamSubject[]
  examScores    ExamScore[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([subjectId])
  @@index([quarterId])
  @@index([examType])
  @@map("exams")
}

model Grade {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  studentId      String
  subjectId      String
  examId         String?
  score          Float
  maxScore       Float    @default(20.0)
  coefficient    Float    @default(1.0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear  AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel   @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  student       Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject       Subject        @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  exam          Exam?          @relation(fields: [examId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([subjectId])
  @@map("grades")
}

model Quarter {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  name           String
  number         Int
  startDate      DateTime
  endDate        DateTime
  isCurrent      Boolean  @default(false)
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  creator      User?        @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  gradeCalculations GradeCalculation[]
  reportCards ReportCard[]
  rankings Ranking[]
  honorRolls HonorRoll[]
  classCouncils ClassCouncil[]
  exams Exam[]
  councilDecisions CouncilDecision[]

  @@map("quarters")
}

// ============================================================================
// TEACHERS & HR
// ============================================================================

model Teacher {
  id             String   @id @default(uuid())
  tenantId       String
  schoolLevelId  String
  matricule      String
  firstName      String
  lastName       String
  gender         String?
  dateOfBirth    DateTime?
  address        String?
  phone          String?
  email          String?
  departmentId   String?
  position       String?
  specialization String?
  subjectId      String?
  academicYearId String?
  hireDate       DateTime?
  contractType   String?
  status         String   @default("active")
  workingHours   Int?
  salary         Decimal? @db.Decimal(10, 2)
  bankDetails    String?
  emergencyContact String?
  qualifications String?
  notes          String?
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  department   Department?  @relation("DepartmentTeachers", fields: [departmentId], references: [id], onDelete: SetNull)
  managedDepartment Department? @relation("DepartmentManager")
  subject      Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  creator      User?        @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  staffAssignments StaffAssignment[]
  subjectAssignments SubjectAssignment[]
  timetableEntries TimetableEntry[]
  lessonJournals LessonJournal[]
  teacherSubjects TeacherSubject[]
  teacherClassAssignments TeacherClassAssignment[]
  dailyLogs DailyLog[]
  pedagogicalDocuments PedagogicalDocument[]
  weeklyDutyAssignments WeeklyDutyAssignment[]

  @@map("teachers")
}

model Department {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  managerId   String?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  manager  Teacher? @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  creator  User?    @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  teachers Teacher[] @relation("DepartmentTeachers")

  @@unique([managerId])

  @@map("departments")
}

// ============================================================================
// ATTENDANCE & DISCIPLINE
// ============================================================================

model Absence {
  id           String   @id @default(uuid())
  tenantId     String
  studentId    String
  schoolLevelId String
  classId      String?
  date         DateTime @db.Date
  isJustified  Boolean  @default(false)
  justification String?
  justifiedBy  String?
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schoolLevel SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  class      Class?   @relation(fields: [classId], references: [id], onDelete: SetNull)
  justifier  User?    @relation("AbsenceJustifier", fields: [justifiedBy], references: [id], onDelete: SetNull)
  creator    User?    @relation("AbsenceCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([tenantId, schoolLevelId])
  @@index([studentId])
  @@map("absences")
}

model Discipline {
  id          String   @id @default(uuid())
  tenantId    String
  studentId   String
  schoolLevelId String
  incidentDate DateTime @db.Date
  severity    String?
  description String
  actionTaken String?
  reportedBy  String?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schoolLevel SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  reporter   User?    @relation("DisciplineReporter", fields: [reportedBy], references: [id], onDelete: SetNull)
  creator    User?    @relation("DisciplineCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([tenantId, schoolLevelId])
  @@index([studentId])
  @@map("discipline")
}

// ============================================================================
// FINANCE & PAYMENTS
// ============================================================================

model TuitionPayment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  amount         Float
  currency       String   @default("XOF")
  status         String   // PENDING, COMPLETED, FAILED, REFUNDED
  paymentMethod  String?  // MOBILE_MONEY, CARD, CASH, BANK_TRANSFER
  paymentFlowId  String?
  paidAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  paymentFlow  PaymentFlow? @relation("TuitionPaymentPaymentFlow")
  installments TuitionInstallment[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([status])
  @@map("tuition_payments")
}

model Payment {
  id                String   @id @default(uuid())
  tenantId          String
  academicYearId    String?
  studentId         String
  schoolLevelId     String
  feeConfigurationId String?
  amount            Decimal  @db.Decimal(10, 2)
  paymentMethod     String?
  paymentDate       DateTime @db.Date
  reference         String?
  receiptNumber     String?
  status            String   @default("completed")
  paymentFlowId     String?
  notes             String?
  createdBy         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear     AcademicYear?    @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  student          Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schoolLevel      SchoolLevel      @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  feeConfiguration FeeConfiguration? @relation(fields: [feeConfigurationId], references: [id], onDelete: SetNull)
  creator          User?            @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  paymentFlow      PaymentFlow?     @relation("PaymentPaymentFlow", fields: [paymentFlowId], references: [id], onDelete: SetNull)
  studentFee       StudentFee?      @relation("StudentFeePayment", fields: [studentFeeId], references: [id], onDelete: SetNull)
  receipt          PaymentReceipt?
  studentFeeId     String?
  paymentAllocations PaymentAllocation[]
  notifications PaymentNotification[]

  @@index([tenantId, schoolLevelId])
  @@index([studentId])
  @@index([studentFeeId])
  @@map("payments")
}

model PaymentFlow {
  id        String   @id @default(uuid())
  tenantId  String
  flowType  String   // SAAS, TUITION
  destination String  // ACADEMIA, SCHOOL
  amount    Float
  currency  String   @default("XOF")
  status    String   // PENDING, COMPLETED, FAILED, REFUNDED
  pspReference String? // Référence du Payment Service Provider
  paymentId String?
  tuitionPaymentId String?
  subscriptionId String?
  subscriptionInvoiceId String?
  tuitionInstallmentId String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payment Payment? @relation("PaymentPaymentFlow", fields: [paymentId], references: [id], onDelete: SetNull)
  tuitionPayment TuitionPayment? @relation("TuitionPaymentPaymentFlow", fields: [tuitionPaymentId], references: [id], onDelete: SetNull)
  subscription Subscription? @relation("SubscriptionPaymentFlow", fields: [subscriptionId], references: [id], onDelete: SetNull)
  subscriptionInvoice SubscriptionInvoice? @relation("SubscriptionInvoicePaymentFlow", fields: [subscriptionInvoiceId], references: [id], onDelete: SetNull)
  tuitionInstallment TuitionInstallment? @relation("TuitionInstallmentPaymentFlow", fields: [tuitionInstallmentId], references: [id], onDelete: SetNull)

  @@index([tenantId, flowType])
  @@index([status])
  @@index([pspReference])
  @@map("payment_flows")
}

model SchoolPaymentAccount {
  id              String   @id @default(uuid())
  tenantId        String
  psp             String   // FEDAPAY, etc.
  accountIdentifier String
  accountName     String
  accountType     String?
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  verifiedBy      String?
  isActive        Boolean  @default(true)
  metadata        Json?
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  verifier    User?  @relation("SchoolPaymentAccountVerifier", fields: [verifiedBy], references: [id], onDelete: SetNull)
  creator     User?  @relation("SchoolPaymentAccountCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@unique([tenantId, psp, accountIdentifier])
  @@map("school_payment_accounts")
}

model FeeConfiguration {
  id             String   @id @default(uuid())
  tenantId       String
  name           String
  feeType        String
  schoolLevelId  String
  level          String?
  classId        String?
  academicYearId String?
  amount         Decimal  @db.Decimal(10, 2)
  isRequired     Boolean  @default(true)
  dueDate        DateTime? @db.Date
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  creator      User?        @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  payments     Payment[]

  @@index([tenantId, schoolLevelId])
  @@map("fee_configurations")
}

model Expense {
  id           String   @id @default(uuid())
  tenantId     String
  academicYearId String?
  schoolLevelId String
  category     String
  description  String
  amount       Decimal  @db.Decimal(10, 2)
  expenseDate  DateTime @db.Date
  paymentMethod String?
  reference    String?
  status       String   @default("pending")
  approvedBy   String?
  approvedAt   DateTime?
  attachmentUrl String?
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  approver User?    @relation("ExpenseApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  creator  User?    @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([tenantId, schoolLevelId])
  @@map("expenses")
}

// ============================================================================
// INFRASTRUCTURE
// ============================================================================

model Room {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?  // Optionnel pour compatibilité historique
  roomCode       String   // Ex: Salle A1, LAB-01
  roomName       String
  roomType       String   // CLASSROOM | LAB | IT | EXAM | OTHER
  capacity       Int?
  schoolLevelId  String?  // Niveau scolaire autorisé (optionnel)
  equipment      Json     @default("[]") // [tableaux, projecteur, ordinateurs]
  status         String   @default("ACTIVE") // ACTIVE | MAINTENANCE | UNAVAILABLE
  description    String?
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  creator      User?         @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  reservations RoomReservation[]
  allocations  RoomAllocation[]
  timetableEntries TimetableEntry[]

  @@unique([tenantId, roomCode])
  @@index([tenantId, academicYearId])
  @@index([roomType])
  @@index([status])
  @@map("rooms")
}

// ============================================================================
// COMMUNICATION
// ============================================================================

model Message {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String?
  schoolLevelId  String?
  channelId     String?
  senderUserId  String
  subject       String?
  content       String
  contentFr     String?  // Contenu en français
  contentEn     String?  // Contenu en anglais
  messageType   String   @default("INFO") // INFO | ALERT | REMINDER | DISCIPLINE | FINANCE
  status        String   @default("DRAFT") // DRAFT | PENDING | SENT | DELIVERED | FAILED
  isScheduled   Boolean  @default(false)
  scheduledAt   DateTime?
  sentAt        DateTime?
  isArchived    Boolean  @default(false)
  attachments   Json?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear  AcademicYear?     @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel   SchoolLevel?      @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  channel       CommunicationChannel? @relation(fields: [channelId], references: [id], onDelete: SetNull)
  sender        User              @relation("MessageSender", fields: [senderUserId], references: [id], onDelete: Cascade)
  recipients    MessageRecipient[]
  targets       MessageTarget[]
  scheduled     ScheduledMessage?
  logs          MessageLog[]

  @@index([tenantId])
  @@index([academicYearId])
  @@index([schoolLevelId])
  @@index([channelId])
  @@index([senderUserId])
  @@index([messageType])
  @@index([status])
  @@map("messages")
}

model Announcement {
  id                   String   @id @default(uuid())
  tenantId             String
  schoolLevelId        String
  classId              String?
  title                String
  content              String
  type                 String   @default("GENERAL") // GENERAL, URGENT, ACADEMIC, FINANCIAL, EVENT, MAINTENANCE
  status               String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  target               String   @default("ALL") // ALL, STUDENTS, PARENTS, TEACHERS, STAFF, SPECIFIC_CLASS
  publishedAt          DateTime?
  expiresAt            DateTime?
  isPinned             Boolean  @default(false)
  requiresAcknowledgment Boolean @default(false)
  attachments          Json?
  metadata             Json?
  createdBy            String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schoolLevel SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  class       Class?      @relation(fields: [classId], references: [id], onDelete: Cascade)
  creator     User        @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([tenantId, schoolLevelId])
  @@index([status])
  @@map("announcements")
}

// ============================================================================
// POLICIES
// ============================================================================

model GradingPolicy {
  id              String   @id @default(uuid())
  countryId       String
  name            String
  educationLevel  String
  maxScore        Decimal  @db.Decimal(5, 2)
  passingScore    Decimal  @db.Decimal(5, 2)
  gradeScales     Json
  calculationRules Json?
  reportCardConfig Json?
  isActive        Boolean  @default(true)
  isDefault       Boolean  @default(false)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@map("grading_policies")
}

model SalaryPolicy {
  id                String   @id @default(uuid())
  countryId         String
  name              String
  salaryStructure   Json
  socialContributions Json
  leaveRules        Json?
  bonuses           Json?
  taxRules          Json?
  isActive          Boolean  @default(true)
  isDefault         Boolean  @default(false)
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@map("salary_policies")
}

// ============================================================================
// MODULES
// ============================================================================

model Module {
  id            String   @id @default(uuid())
  tenantId      String
  type          String   // SCOLARITE, FINANCES, RH, PEDAGOGIE, EXAMENS, COMMUNICATION, BIBLIOTHEQUE, LABORATOIRE, TRANSPORT, CANTINE, INFIRMERIE, QHSE, EDUCAST, BOUTIQUE
  name          String
  code          String?
  description   String?
  schoolLevelId String
  status        String   @default("active") // active, inactive, maintenance
  isEnabled     Boolean  @default(true)
  configuration Json     @default("{}")
  permissions   String[] @default([])
  dependencies  String[] @default([])
  order         Int      @default(0)
  route         String?
  icon          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schoolLevel SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)

  @@unique([tenantId, type, schoolLevelId])
  @@index([tenantId, schoolLevelId])
  @@map("modules")
}

// ============================================================================
// FEATURES & CONFIGURATION
// ============================================================================

/**
 * Feature Flags — Modules et fonctionnalités activables/désactivables
 */
model TenantFeature {
  tenantId     String
  featureCode  String  // CANTINE, TRANSPORT, BIBLIOTHEQUE, INFIRMERIE, EDUCAST, PATRONAT, BILINGUAL_TRACK, etc.
  isEnabled    Boolean @default(false)
  status       String  @default("INACTIVE") // ACTIVE, INACTIVE, PENDING_PAYMENT, LOCKED
  enabledAt    DateTime?
  enabledBy    String?
  disabledAt   DateTime?
  disabledBy   String?
  metadata     Json?   // Configuration spécifique au feature
  billingImpact String? // Impact sur facturation (mensuel, annuel, etc.)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  enabledByUser User? @relation("TenantFeatureEnabledBy", fields: [enabledBy], references: [id], onDelete: SetNull)
  disabledByUser User? @relation("TenantFeatureDisabledBy", fields: [disabledBy], references: [id], onDelete: SetNull)

  @@id([tenantId, featureCode])
  @@index([tenantId, status])
  @@map("tenant_features")
}

// ============================================================================
// COMPLIANCE & AUDIT
// ============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  resource   String   // Nom de la ressource (ex: "Student", "Payment")
  resourceId String?
  tableName  String
  recordId   String?
  oldData    Json?
  newData    Json?
  ipAddress  String?
  userAgent  String?
  changes    Json?
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([tenantId, resource])
  @@index([userId])
  @@map("audit_logs")
}

model DataExport {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String
  exportType String   // full, partial, anonymized
  filePath   String?
  status     String   @default("pending") // pending, processing, completed, failed
  metadata   Json?
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("data_exports")
}

model DataConsent {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String
  consentType String   // data_processing, marketing, analytics, etc.
  consented   Boolean  @default(false)
  consentText String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("data_consents")
}

// ============================================================================
// TENANT DOMAINS & SETTINGS
// ============================================================================

model TenantDomain {
  id        String   @id @default(uuid())
  tenantId  String
  domain    String
  isPrimary Boolean  @default(false)
  isActive  Boolean  @default(true)
  verifiedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, domain])
  @@index([domain])
  @@map("tenant_domains")
}

model TenantSetting {
  id        String   @id @default(uuid())
  tenantId  String
  key       String
  value     Json?
  category  String?  // general, billing, features, communication, security, orion, atlas, offline, etc.
  description String?
  isSystem   Boolean  @default(false) // Paramètre système vs personnalisé
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  history SettingsHistory[]

  @@unique([tenantId, key])
  @@index([tenantId, category])
  @@map("tenant_settings")
}

// ============================================================================
// MODULE TRANSVERSAL — PARAMÈTRES DE L'APPLICATION
// ============================================================================

/**
 * Paramètres de l'école (identité, locale, etc.)
 */
model SchoolSettings {
  id              String   @id @default(uuid())
  tenantId        String   @unique
  schoolName      String
  logoUrl         String?
  sealUrl         String?  // Cachet
  signatureUrl    String?  // Signature
  timezone        String   @default("Africa/Porto-Novo") // Fuseau horaire
  defaultLanguage String   @default("FR") // FR | EN
  currency        String   @default("XOF") // Code devise ISO
  currencySymbol  String   @default("FCFA")
  address         String?
  phone           String?
  email           String?
  website         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("school_settings")
}

/**
 * Historique des changements de paramètres (audit immuable)
 */
model SettingsHistory {
  id            String   @id @default(uuid())
  tenantId      String
  settingId     String?
  key           String   // Clé du paramètre modifié
  category      String?
  oldValue      Json?
  newValue      Json?
  changedBy     String?
  changedAt     DateTime @default(now())
  reason        String?  // Raison du changement
  ipAddress     String?
  userAgent     String?

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  setting TenantSetting? @relation(fields: [settingId], references: [id], onDelete: SetNull)
  user    User?         @relation("SettingsHistoryUser", fields: [changedBy], references: [id], onDelete: SetNull)

  @@index([tenantId, key])
  @@index([tenantId, category])
  @@index([changedAt])
  @@map("settings_history")
}

/**
 * Paramètres de sécurité et conformité
 */
model SecuritySettings {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  passwordMinLength     Int      @default(8)
  passwordRequireUppercase Boolean @default(true)
  passwordRequireLowercase Boolean @default(true)
  passwordRequireNumbers Boolean @default(true)
  passwordRequireSpecial Boolean @default(false)
  passwordExpirationDays Int?    // Expiration des mots de passe (null = jamais)
  sessionTimeoutMinutes Int      @default(30)
  maxLoginAttempts      Int      @default(5)
  lockoutDurationMinutes Int     @default(15)
  twoFactorEnabled      Boolean  @default(false)
  requireEmailVerification Boolean @default(true)
  auditLogRetentionDays Int      @default(365) // Conservation des logs d'audit
  dataRetentionYears    Int      @default(7)   // Conservation des données
  gdprCompliant         Boolean  @default(false)
  allowInspectionAccess Boolean  @default(false) // Accès inspection externe
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("security_settings")
}

/**
 * Paramètres de synchronisation offline
 */
model OfflineSyncSettings {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  isEnabled             Boolean  @default(true)
  syncFrequencyMinutes  Int      @default(15) // Fréquence de synchronisation
  conflictResolution    String   @default("SERVER_WINS") // SERVER_WINS | CLIENT_WINS | MANUAL
  autoSyncOnConnect     Boolean  @default(true)
  maxOfflineDays        Int      @default(7) // Nombre max de jours sans sync
  allowOfflineModification Boolean @default(true)
  syncOnBackground      Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("offline_sync_settings")
}

/**
 * Paramètres ORION (IA de pilotage)
 */
model OrionSettings {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  isEnabled             Boolean  @default(true)
  alertThresholdCritical Int     @default(5)   // Seuil d'alertes critiques
  alertThresholdWarning  Int     @default(10)  // Seuil d'alertes warning
  kpiCalculationFrequency String @default("DAILY") // HOURLY | DAILY | WEEKLY
  autoGenerateInsights   Boolean @default(true)
  insightsFrequency      String  @default("WEEKLY") // DAILY | WEEKLY | MONTHLY
  visibleKPICategories   String[] @default(["PEDAGOGICAL", "FINANCIAL", "RH", "QHSE"])
  allowOrionExports      Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("orion_settings")
}

/**
 * Paramètres ATLAS (Chatbot IA)
 */
model AtlasSettings {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  isEnabled             Boolean  @default(false)
  scope                 String   @default("LIMITED") // FULL | LIMITED | DISABLED
  allowedModules        String[] @default([]) // Modules accessibles par ATLAS
  allowHumanHandoff     Boolean  @default(true) // Passage à un humain
  conversationHistoryDays Int    @default(90)  // Conservation historique
  maxConversationsPerDay Int?    // Limite de conversations par jour (null = illimité)
  language              String   @default("FR") // FR | EN
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("atlas_settings")
}

// ============================================================================
// MODULE TRANSVERSAL — RÉUNIONS ADMINISTRATIVES, PÉDAGOGIQUES & PARENTS
// ============================================================================

/**
 * Réunions (administratives, pédagogiques, parents)
 */
model Meeting {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  meetingType    String   // ADMIN | PEDAGOGIC | PARENTS
  scopeType      String   // SCHOOL | LEVEL | CLASS | STUDENT
  schoolLevelId  String?  // ID du niveau si scopeType = LEVEL
  classId        String?  // ID de la classe si scopeType = CLASS
  studentId      String?  // ID de l'étudiant si scopeType = STUDENT
  title          String
  description    String?
  meetingDate    DateTime @db.Date
  startTime      String?  // Format HH:mm
  endTime        String?  // Format HH:mm
  location       String?  // Salle / en ligne
  locationOnline Boolean  @default(false) // Réunion en ligne
  meetingLink    String?  // Lien pour réunion en ligne
  status         String   @default("PLANNED") // PLANNED | HELD | CANCELLED | POSTPONED
  cancelledAt    DateTime?
  cancelledBy    String?
  cancelledReason String?
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear       @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?       @relation("MeetingSchoolLevel", fields: [schoolLevelId], references: [id], onDelete: SetNull)
  class        Class?             @relation("MeetingClass", fields: [classId], references: [id], onDelete: SetNull)
  student      Student?           @relation("MeetingStudent", fields: [studentId], references: [id], onDelete: SetNull)
  creator      User?              @relation("MeetingCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  cancelledByUser User?           @relation("MeetingCancelledBy", fields: [cancelledBy], references: [id], onDelete: SetNull)
  participants MeetingParticipant[]
  agendas      MeetingAgenda[]
  minutes      MeetingMinutes[]
  decisions    MeetingDecision[]
  attachments  MeetingAttachment[]
  notifications MeetingNotification[]

  @@index([tenantId, academicYearId])
  @@index([meetingType])
  @@index([scopeType])
  @@index([schoolLevelId])
  @@index([classId])
  @@index([studentId])
  @@index([status])
  @@index([meetingDate])
  @@map("meetings")
}

/**
 * Participants aux réunions
 */
model MeetingParticipant {
  id             String   @id @default(uuid())
  meetingId      String
  participantType String   // STAFF | GUARDIAN | STUDENT
  participantId  String   // ID du staff/guardian/student
  invitedAt      DateTime @default(now())
  invitedBy      String?
  attendanceStatus String? // PRESENT | ABSENT | EXCUSED | NOT_ATTENDED
  attendanceTime DateTime? // Heure d'arrivée
  excuseReason   String?  // Raison d'absence si excusé
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  meeting       Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  inviter       User?   @relation("MeetingParticipantInviter", fields: [invitedBy], references: [id], onDelete: SetNull)

  @@unique([meetingId, participantType, participantId])
  @@index([meetingId])
  @@index([participantType, participantId])
  @@index([attendanceStatus])
  @@map("meeting_participants")
}

/**
 * Ordres du jour des réunions
 */
model MeetingAgenda {
  id             String   @id @default(uuid())
  meetingId      String
  agendaOrder    Int      @default(0) // Ordre dans l'ordre du jour
  topic          String
  description    String?
  presenterId    String?  // User qui présente ce point
  durationMinutes Int?    // Durée estimée en minutes
  status         String   @default("PLANNED") // PLANNED | COVERED | SKIPPED
  notes          String?  // Notes de discussion
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  presenter User?   @relation("MeetingAgendaPresenter", fields: [presenterId], references: [id], onDelete: SetNull)

  @@index([meetingId])
  @@index([meetingId, agendaOrder])
  @@map("meeting_agendas")
}

/**
 * Templates officiels de comptes rendus de réunions
 */
model MeetingMinutesTemplate {
  id            String   @id @default(uuid())
  tenantId      String?
  meetingType   String   // ADMIN | PEDAGOGIC | PARENTS
  name          String   // Nom du template
  description   String?
  template      String   // Template avec variables (Handlebars/Mustache)
  structure     Json?    // Structure JSON du template
  isSystem      Boolean  @default(false) // Template système vs personnalisé
  isActive      Boolean  @default(true)
  language      String   @default("FR") // FR | EN
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  minutes      MeetingMinutes[]
  versions     MeetingMinutesVersion[]

  @@index([tenantId, meetingType])
  @@index([isSystem])
  @@index([isActive])
  @@map("meeting_minutes_templates")
}

/**
 * Comptes rendus de réunions
 */
model MeetingMinutes {
  id            String   @id @default(uuid())
  meetingId     String   @unique
  templateId    String?  // Template utilisé
  version       Int      @default(1) // Version du compte rendu
  content       String   // Contenu du compte rendu (markdown ou texte)
  renderedContent String? // Contenu rendu final (après remplacement des variables)
  pdfPath       String?  // Chemin du PDF généré
  language      String   @default("FR") // FR | EN (pour bilingue)
  recordedBy    String?  // User qui a pris les notes
  recordedAt    DateTime?
  validatedBy   String?  // User qui a validé le compte rendu
  validatedAt   DateTime?
  validated     Boolean  @default(false) // Compte rendu validé par la direction
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  meeting     Meeting             @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  template    MeetingMinutesTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  recorder    User?   @relation("MeetingMinutesRecorder", fields: [recordedBy], references: [id], onDelete: SetNull)
  validator   User?   @relation("MeetingMinutesValidator", fields: [validatedBy], references: [id], onDelete: SetNull)
  history     MeetingMinutesVersion[]
  signatures  ElectronicSignature[]

  @@index([meetingId])
  @@index([templateId])
  @@index([validated])
  @@index([language])
  @@index([version])
  @@map("meeting_minutes")
}

/**
 * Historique des versions de comptes rendus (immuable)
 */
model MeetingMinutesVersion {
  id            String   @id @default(uuid())
  minutesId     String
  templateId    String?
  version       Int      // Numéro de version
  content       String   // Contenu de cette version
  renderedContent String? // Contenu rendu de cette version
  pdfPath       String?  // Chemin du PDF de cette version
  changes       String?  // Description des changements
  modifiedBy    String?
  modifiedAt    DateTime @default(now())
  validatedBy   String?  // User qui a validé cette version
  validatedAt   DateTime?

  minutes       MeetingMinutes        @relation(fields: [minutesId], references: [id], onDelete: Cascade)
  template      MeetingMinutesTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  modifier      User?                 @relation("MeetingMinutesVersionModifier", fields: [modifiedBy], references: [id], onDelete: SetNull)
  validator     User?                 @relation("MeetingMinutesVersionValidator", fields: [validatedBy], references: [id], onDelete: SetNull)

  @@index([minutesId])
  @@index([version])
  @@index([modifiedAt])
  @@map("meeting_minutes_versions")
}

/**
 * Signatures électroniques pour les comptes rendus
 */
model ElectronicSignature {
  id            String   @id @default(uuid())
  minutesId     String
  userId        String   // User qui signe
  signatureType String   @default("VALIDATION") // VALIDATION | APPROVAL | ACKNOWLEDGMENT
  signatureHash String   // Hash de la signature (pour intégrité)
  signatureData String?  // Données de signature (image, certificat, etc.)
  ipAddress     String?
  userAgent     String?
  signedAt      DateTime @default(now())
  createdAt     DateTime @default(now())

  minutes MeetingMinutes @relation(fields: [minutesId], references: [id], onDelete: Cascade)
  user    User          @relation("ElectronicSignatureUser", fields: [userId], references: [id], onDelete: Restrict)

  @@unique([minutesId, userId, signatureType])
  @@index([minutesId])
  @@index([userId])
  @@index([signedAt])
  @@map("electronic_signatures")
}

/**
 * Décisions prises lors des réunions
 */
model MeetingDecision {
  id               String   @id @default(uuid())
  meetingId        String
  decisionText     String   // Texte de la décision
  decisionOrder    Int      @default(0) // Ordre de la décision dans la réunion
  responsibleId    String?  // User responsable de l'exécution
  dueDate          DateTime? // Date limite d'exécution
  status           String   @default("PENDING") // PENDING | IN_PROGRESS | DONE | CANCELLED
  completionDate   DateTime? // Date d'exécution
  completionNotes  String?  // Notes d'exécution
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  meeting     Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  responsible User?   @relation("MeetingDecisionResponsible", fields: [responsibleId], references: [id], onDelete: SetNull)

  @@index([meetingId])
  @@index([responsibleId])
  @@index([status])
  @@index([dueDate])
  @@map("meeting_decisions")
}

/**
 * Pièces jointes des réunions
 */
model MeetingAttachment {
  id          String   @id @default(uuid())
  meetingId   String
  fileName    String
  filePath    String   // Chemin du fichier
  fileSize    Int?     // Taille en bytes
  fileType    String?  // Type MIME
  uploadedBy  String?
  createdAt   DateTime @default(now())

  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  uploader  User?   @relation("MeetingAttachmentUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@index([meetingId])
  @@map("meeting_attachments")
}

/**
 * Notifications envoyées pour les réunions
 */
model MeetingNotification {
  id          String   @id @default(uuid())
  meetingId   String
  participantId String // ID du participant
  channel     String   // SMS | EMAIL | WHATSAPP | PUSH
  status      String   @default("PENDING") // PENDING | SENT | FAILED | DELIVERED
  sentAt      DateTime?
  errorMessage String?
  createdAt   DateTime @default(now())

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([participantId])
  @@index([status])
  @@index([channel])
  @@map("meeting_notifications")
}

// ============================================================================
// SESSIONS & AUTH
// ============================================================================

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  ipAddress String?
  userAgent String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_resets")
}

// ============================================================================
// GUARDIANS & STUDENT RELATIONSHIPS
// ============================================================================

model Guardian {
  id        String   @id @default(uuid())
  tenantId  String
  firstName String
  lastName  String
  phone     String?
  email     String?
  relationship String? // PARENT, GUARDIAN, etc.
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  studentGuardians StudentGuardian[]

  @@index([tenantId])
  @@map("guardians")
}

model StudentGuardian {
  id         String   @id @default(uuid())
  tenantId   String
  studentId  String
  guardianId String
  relationship String // MOTHER, FATHER, GUARDIAN, etc.
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardian Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([studentId, guardianId])
  @@index([tenantId])
  @@map("student_guardians")
}

model StudentEnrollment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  classId        String?
  enrollmentType String   @default("NEW") // NEW | REPEAT | TRANSFER
  enrollmentDate DateTime
  status         String   @default("PENDING") // PENDING | VALIDATED | REJECTED | ACTIVE | TRANSFERRED | GRADUATED | WITHDRAWN
  exitDate       DateTime?
  exitReason     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("student_enrollments")
}

// ============================================================================
// MODULE 1 - MATRICULE GLOBAL UNIQUE & CARTES SCOLAIRES
// ============================================================================

/**
 * Identifiant global unique de l'élève
 * Matricule unique à l'échelle de toute la plateforme Academia Hub
 * Format: AH-BJ-XXXX-YYYY-NNNNN
 */
model StudentIdentifier {
  id                    String   @id @default(uuid())
  tenantId              String
  studentId             String   @unique
  globalMatricule       String   @unique // Format: AH-BJ-XXXX-YYYY-NNNNN (UNIQUE GLOBAL)
  countryCode           String   @default("BJ") // BJ pour Bénin (extensible)
  institutionCode       String   // Code établissement (4 caractères)
  firstEnrollmentYear   Int      // Année de première inscription
  sequenceNumber        Int      // Numéro séquentiel global (5 chiffres)
  temporaryLocalId      String?  // ID temporaire si généré offline
  isOfflineGenerated    Boolean  @default(false) // Généré en mode offline
  synchronizedAt        DateTime? // Date de synchronisation après offline
  generatedAt           DateTime @default(now())
  generatedBy           String?  // User/System qui a généré
  locked                Boolean  @default(true) // Verrouillé après création (non modifiable)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  generator User? @relation("StudentIdentifierGenerator", fields: [generatedBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([studentId])
  @@index([globalMatricule])
  @@index([countryCode, institutionCode, firstEnrollmentYear])
  @@index([isOfflineGenerated, synchronizedAt])
  @@map("student_identifiers")
}

/**
 * Carte d'identité scolaire officielle
 * Une carte par année scolaire (historique conservé)
 */
model StudentIdCard {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  cardNumber     String   @unique // Numéro unique de la carte (format: CARD-YYYY-XXXXXX)
  qrPayload      String   // Données du QR Code (matricule + tenant + hash)
  qrHash         String   // Hash pour vérification d'intégrité
  frontImagePath String?  // Chemin image face avant (PNG/PDF)
  backImagePath  String?  // Chemin image face arrière (PNG/PDF)
  pdfPath        String?  // Chemin PDF complet (face avant + arrière)
  generatedAt    DateTime @default(now())
  generatedBy    String?  // User qui a généré
  validUntil     DateTime? // Date d'expiration (fin année scolaire)
  isActive       Boolean  @default(true) // Carte active
  isRevoked      Boolean  @default(false) // Carte révoquée (perdue, volée, etc.)
  revokedAt      DateTime?
  revokedBy      String?
  revocationReason String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  generator    User?        @relation("StudentIdCardGenerator", fields: [generatedBy], references: [id], onDelete: SetNull)
  revoker      User?        @relation("StudentIdCardRevoker", fields: [revokedBy], references: [id], onDelete: SetNull)

  @@unique([tenantId, academicYearId, studentId]) // Une carte par élève par année
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([cardNumber])
  @@index([qrHash])
  @@index([isActive, isRevoked])
  @@index([validUntil])
  @@map("student_id_cards")
}

// ============================================================================
// MODULE 1 - VÉRIFICATION PUBLIQUE & DOSSIER SCOLAIRE NUMÉRIQUE
// ============================================================================

/**
 * Token de vérification publique pour QR Code
 * Permet de vérifier l'identité d'un élève sans exposer de données sensibles
 */
model PublicVerificationToken {
  id              String   @id @default(uuid())
  tenantId        String
  entityType      String   @default("STUDENT") // STUDENT (extensible)
  entityId        String   // student_id
  tokenHash       String   @unique // Hash du token (non devinable)
  token           String   @unique // Token original (stocké temporairement pour génération)
  academicYearId  String
  expiresAt       DateTime // Expiration automatique (fin année scolaire + 1 mois)
  isActive        Boolean  @default(true)
  verificationCount Int    @default(0) // Nombre de vérifications effectuées
  lastVerifiedAt  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  student      Student?      @relation("PublicVerificationTokenStudent", fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([tenantId, academicYearId, entityId]) // Un token actif par élève par année
  @@index([tokenHash])
  @@index([entityId, academicYearId])
  @@index([expiresAt, isActive])
  @@map("public_verification_tokens")
}

/**
 * Enregistrement académique par année scolaire
 * Centralise le parcours scolaire de l'élève
 */
model StudentAcademicRecord {
  id              String   @id @default(uuid())
  tenantId        String
  studentId       String
  academicYearId  String
  classId         String?
  schoolLevelId   String
  level           String?  // Niveau scolaire (ex: 6ème, 5ème, Terminale)
  enrollmentStatus String  @default("ACTIVE") // ACTIVE, TRANSFERRED, GRADUATED, REPEAT
  averageScore    Decimal? @db.Decimal(5, 2) // Moyenne générale
  rank            Int?     // Rang dans la classe
  totalAbsences   Int      @default(0)
  totalIncidents  Int      @default(0)
  totalSanctions  Int      @default(0)
  notes           Json?    // Notes additionnelles
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student      Student      @relation("StudentAcademicRecordStudent", fields: [studentId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation("StudentAcademicRecordAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  class        Class?       @relation("StudentAcademicRecordClass", fields: [classId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel  @relation("StudentAcademicRecordSchoolLevel", fields: [schoolLevelId], references: [id], onDelete: Restrict)

  @@unique([studentId, academicYearId]) // Un enregistrement par élève par année
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@index([classId])
  @@map("student_academic_records")
}

/**
 * Résumé disciplinaire par année scolaire
 * Synthèse des absences, incidents et sanctions
 */
model StudentDisciplinarySummary {
  id              String   @id @default(uuid())
  tenantId        String
  studentId       String
  academicYearId  String
  absencesCount   Int      @default(0) // Total absences
  justifiedAbsences Int   @default(0) // Absences justifiées
  unjustifiedAbsences Int @default(0) // Absences non justifiées
  incidentsCount Int      @default(0) // Total incidents
  minorIncidents  Int      @default(0) // Incidents mineurs
  majorIncidents  Int      @default(0) // Incidents majeurs
  sanctionsCount Int       @default(0) // Total sanctions
  warningsCount  Int       @default(0) // Avertissements
  suspensionsCount Int     @default(0) // Suspensions
  expulsionsCount Int       @default(0) // Exclusions
  lastIncidentDate DateTime?
  lastSanctionDate DateTime?
  notes           Json?    // Notes additionnelles
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student      Student      @relation("StudentDisciplinarySummaryStudent", fields: [studentId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation("StudentDisciplinarySummaryAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)

  @@unique([studentId, academicYearId]) // Un résumé par élève par année
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@map("student_disciplinary_summaries")
}

model Admission {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  firstName      String
  lastName       String
  dateOfBirth    DateTime?
  gender         String?
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED, ENROLLED
  applicationDate DateTime @default(now())
  decisionDate   DateTime?
  decisionBy     String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([status])
  @@map("admissions")
}

model TransferRequest {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  studentId      String
  fromClassId    String
  toClassId      String
  reason         String?
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED
  requestedBy    String?
  approvedBy     String?
  approvedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@map("transfer_requests")
}

model ClassStudent {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  classId        String
  studentId      String
  enrollmentDate DateTime
  exitDate       DateTime?
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  class        Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId, academicYearId])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("class_students")
}

model ClassTransfer {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  fromClassId    String
  toClassId      String
  transferDate   DateTime
  reason         String?
  approvedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  fromClass    Class?       @relation("ClassTransfersFrom", fields: [fromClassId], references: [id], onDelete: SetNull)
  toClass      Class?       @relation("ClassTransfersTo", fields: [toClassId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("class_transfers")
}

model DisciplinaryAction {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  disciplineId   String?
  actionType     String   // WARNING, SUSPENSION, EXPULSION, etc.
  description    String
  actionDate     DateTime
  duration       Int?     // Durée en jours (pour suspensions)
  status         String   @default("ACTIVE") // ACTIVE, COMPLETED, REVOKED
  decidedBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("disciplinary_actions")
}

model StudentDocument {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  documentType   String   // BIRTH_CERTIFICATE, ID_CARD, PHOTO, etc.
  fileName       String
  filePath       String
  fileSize       Int?
  mimeType       String?
  uploadedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("student_documents")
}

model DocumentTemplate {
  id             String   @id @default(uuid())
  tenantId       String
  name           String
  type           String   // REPORT_CARD, CERTIFICATE, LETTER, etc.
  template       String   // Contenu du template (HTML, Markdown, etc.)
  variables      Json?    // Variables disponibles dans le template
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  generatedDocuments GeneratedDocument[]

  @@index([tenantId, type])
  @@map("document_templates")
}

model GeneratedDocument {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  templateId     String?
  documentType   String
  fileName       String
  filePath       String
  fileSize       Int?
  mimeType       String?
  metadata       Json?
  generatedBy    String?
  createdAt      DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  template     DocumentTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([documentType])
  @@map("generated_documents")
}

// ============================================================================
// GED INSTITUTIONNELLE
// ============================================================================

model GedDocument {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  category       String   // ADMIN, PEDAGOGIQUE, FINANCIER, QHSE, RH
  title          String
  description    String?
  sourceType     String?  // STUDENT_DOCUMENT, GENERATED_DOCUMENT, QHSE_AUDIT, etc.
  sourceId       String?
  archivalStatus String   @default("DRAFT") // DRAFT, VALIDATED, ARCHIVED
  retentionPolicy String? // Durée légale, ex: 5Y, 10Y
  metadata       Json?
  createdById    String?
  validatedById  String?
  validatedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  createdBy    User?        @relation("GedDocumentCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  validatedBy  User?        @relation("GedDocumentValidatedBy", fields: [validatedById], references: [id], onDelete: SetNull)
  versions     GedDocumentVersion[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([category, archivalStatus])
  @@index([sourceType, sourceId])
  @@map("ged_documents")
}

model GedDocumentVersion {
  id           String   @id @default(uuid())
  documentId   String
  versionNumber Int
  filePath     String
  fileName     String
  fileSize     Int
  mimeType     String
  hash         String?
  createdById  String?
  createdAt    DateTime @default(now())

  document GedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  createdBy User?      @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@map("ged_document_versions")
}

// ============================================================================
// ATTENDANCE & DISCIPLINE
// ============================================================================

model AttendanceRecord {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  classId        String?
  date           DateTime
  status         String   // PRESENT, ABSENT, LATE, EXCUSED
  notes          String?
  recordedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)

  @@unique([studentId, date])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([date])
  @@map("attendance_records")
}

model DisciplineRecord {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  incidentDate   DateTime
  severity       String   // MINOR, MODERATE, MAJOR, CRITICAL
  description    String
  actionTaken    String?
  reportedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([incidentDate])
  @@map("discipline_records")
}

// ============================================================================
// FINANCIAL - SUBSCRIPTIONS & INVOICES (SAAS)
// ============================================================================

model Subscription {
  id                String   @id @default(uuid())
  tenantId          String
  plan              String   // BASIC, PREMIUM, ENTERPRISE
  status            String   @default("TRIAL") // TRIAL, ACTIVE, EXPIRED, SUSPENDED, CANCELLED
  startDate         DateTime
  endDate           DateTime?
  trialEndsAt       DateTime?
  nextPaymentDueAt  DateTime?
  amount            Float
  currency          String   @default("XOF")
  billingCycle      String   @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY
  autoRenew         Boolean  @default(true)
  cancelledAt       DateTime?
  cancelledBy       String?
  cancellationReason String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices SubscriptionInvoice[]
  paymentFlows PaymentFlow[]

  @@index([tenantId])
  @@index([status])
  @@index([nextPaymentDueAt])
  @@map("subscriptions")
}

model SubscriptionInvoice {
  id             String   @id @default(uuid())
  tenantId       String
  subscriptionId String
  invoiceNumber  String   @unique
  amount         Float
  currency       String   @default("XOF")
  status         String   @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED
  issueDate      DateTime @default(now())
  dueDate        DateTime
  paidAt         DateTime?
  paymentFlowId  String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  paymentFlow  PaymentFlow? @relation("SubscriptionInvoicePaymentFlow", fields: [paymentFlowId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([status])
  @@map("subscription_invoices")
}

model TuitionInstallment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  tuitionPaymentId String
  installmentNumber Int
  amount         Float
  dueDate       DateTime
  paidAt        DateTime?
  status        String   @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED
  paymentFlowId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear   AcademicYear   @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel    SchoolLevel    @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  tuitionPayment TuitionPayment @relation(fields: [tuitionPaymentId], references: [id], onDelete: Cascade)
  paymentFlow    PaymentFlow?   @relation("TuitionInstallmentPaymentFlow", fields: [paymentFlowId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([tuitionPaymentId])
  @@index([dueDate])
  @@map("tuition_installments")
}

model Discount {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  name           String
  type           String   // PERCENTAGE, FIXED_AMOUNT
  value          Float
  applicableTo   String?  // TUITION, FEES, ALL
  startDate      DateTime?
  endDate        DateTime?
  isActive       Boolean  @default(true)
  maxUses        Int?
  currentUses    Int      @default(0)
  conditions     Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([isActive])
  @@map("discounts")
}

model PaymentPlan {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  name           String
  description    String?
  totalAmount    Float
  numberOfInstallments Int
  frequency      String   @default("MONTHLY") // MONTHLY, QUARTERLY, CUSTOM
  startDate      DateTime
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([isActive])
  @@map("payment_plans")
}

model ExpenseCategory {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  name           String
  description    String?
  code           String?
  parentId       String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  expenses     Expense[]
  parent       ExpenseCategory? @relation("ExpenseCategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children     ExpenseCategory[] @relation("ExpenseCategoryHierarchy")

  @@index([tenantId])
  @@index([parentId])
  @@map("expense_categories")
}

model CashClosure {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  closureDate    DateTime
  openingBalance Float
  closingBalance Float
  totalIncome    Float
  totalExpenses  Float
  discrepancy    Float?
  notes          String?
  closedBy       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)

  @@unique([tenantId, academicYearId, schoolLevelId, closureDate])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("cash_closures")
}

model TreasuryMovement {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  type           String   // INCOME, EXPENSE, TRANSFER
  amount         Float
  currency       String   @default("XOF")
  description    String
  reference      String?
  movementDate   DateTime
  relatedPaymentId String?
  relatedExpenseId String?
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([movementDate])
  @@index([type])
  @@map("treasury_movements")
}

// ============================================================================
// HR & PERSONNEL
// ============================================================================

model Staff {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  employeeNumber String   @unique
  firstName      String
  lastName       String
  gender         String?
  dateOfBirth    DateTime?
  birthDate      DateTime? @db.Date
  phone          String?
  email          String?
  address        String?
  position       String?
  department     String?
  roleType       String   @default("TEACHER") // ADMIN | TEACHER | SUPPORT
  hireDate       DateTime?
  contractType   String?
  status         String   @default("ACTIVE") // ACTIVE | SUSPENDED | ARCHIVED
  salary         Decimal? @db.Decimal(10, 2)
  bankDetails    Json?
  emergencyContact Json?
  qualifications String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  documents    StaffDocument[]
  assignments  StaffAssignment[]
  contracts    Contract[]
  attendance   StaffAttendance[]
  evaluations  StaffEvaluation[]
  trainings    StaffTraining[]
  overtimeRecords OvertimeRecord[]
  payrollItems PayrollItem[]
  employeeCNSS EmployeeCNSS?
  taxWithholdings TaxWithholding[]
  salaryPayments SalaryPayment[]

  @@index([tenantId])
  @@index([employeeNumber])
  @@index([status])
  @@index([roleType])
  @@map("staff")
}

model StaffDocument {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  staffId        String
  documentType   String   // CIP, CONTRACT, DIPLOMA, ID_CARD, CV, etc.
  fileName       String
  filePath       String
  fileSize       Int?
  mimeType       String?
  validated      Boolean  @default(false)
  uploadedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  staff        Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([staffId])
  @@index([documentType])
  @@map("staff_documents")
}

model StaffAssignment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  staffId        String
  classId        String?
  subjectId      String?
  role           String   // TEACHER, ASSISTANT, SUPERVISOR, etc.
  startDate      DateTime
  endDate        DateTime?
  status         String   @default("ACTIVE")
  hoursPerWeek   Int?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject      Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([staffId])
  @@map("staff_assignments")
}

model Contract {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  staffId        String
  templateId     String?
  contractType   String   // CDI | CDD | VACATION
  startDate      DateTime @db.Date
  endDate        DateTime? @db.Date
  baseSalary     Decimal  @db.Decimal(10, 2)
  paymentMode    String   @default("BANK") // BANK | MOBILE_MONEY | CASH
  status         String   @default("ACTIVE") // ACTIVE, EXPIRED, TERMINATED, RENEWED
  terms          Json?
  signedAt       DateTime?
  signedBy       String?
  terminatedAt   DateTime?
  terminationReason String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  staff        Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)
  template     ContractTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([staffId])
  @@index([status])
  @@index([contractType])
  @@map("employment_contracts")
}

model ContractTemplate {
  id             String   @id @default(uuid())
  tenantId       String
  name           String
  contractType   String
  template       String   // Contenu du template
  variables      Json?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contracts Contract[]

  @@index([tenantId])
  @@map("contract_templates")
}

model StaffAttendance {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  staffId        String
  date           DateTime @db.Date
  checkIn        DateTime?
  checkOut       DateTime?
  status         String   @default("PRESENT") // PRESENT | ABSENT
  hoursWorked   Float?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, date])
  @@index([tenantId, academicYearId])
  @@index([staffId])
  @@index([date])
  @@index([status])
  @@map("staff_attendances")
}

model StaffEvaluation {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  staffId        String
  evaluatorId    String?
  score          Decimal? @db.Decimal(5, 2)
  comments       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  staff        Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)
  evaluator    User?         @relation("StaffEvaluator", fields: [evaluatorId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([staffId])
  @@index([evaluatorId])
  @@map("staff_evaluations")
}

model TrainingSession {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  title          String
  description    String?
  trainer         String?
  date           DateTime
  duration       Int?     // Durée en heures
  participants   String[] @default([]) // IDs des staff participants
  status         String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([date])
  @@map("training_sessions")
}

model Payroll {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  month          String   // Format: YYYY-MM
  startDate      DateTime
  endDate        DateTime
  status         String   @default("DRAFT") // DRAFT | VALIDATED | PAID
  totalAmount    Decimal  @db.Decimal(10, 2)
  processedBy    String?
  processedAt    DateTime?
  paidAt         DateTime?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  items        PayrollItem[]

  @@unique([tenantId, academicYearId, month])
  @@index([tenantId, academicYearId])
  @@index([status])
  @@map("payrolls")
}

model PayrollItem {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  payrollId      String
  staffId        String
  baseSalary     Decimal  @db.Decimal(10, 2)
  overtimeAmount Decimal  @default(0) @db.Decimal(10, 2)
  bonuses        Decimal  @default(0) @db.Decimal(10, 2)
  grossSalary    Decimal  @db.Decimal(10, 2) // Brut total (base + heures sup + primes)
  cnssEmployee   Decimal  @default(0) @db.Decimal(10, 2) // Part employé CNSS
  cnssEmployer   Decimal  @default(0) @db.Decimal(10, 2) // Part employeur CNSS (non déduite du salaire)
  taxableAmount  Decimal  @db.Decimal(10, 2) // Net imposable (brut - CNSS employé)
  irppAmount     Decimal  @default(0) @db.Decimal(10, 2) // IRPP retenu
  otherDeductions Decimal @default(0) @db.Decimal(10, 2) // Autres retenues (avances, sanctions, etc.)
  totalDeductions Decimal @db.Decimal(10, 2) // Total retenues
  netSalary      Decimal  @db.Decimal(10, 2) // Net à payer (brut - total retenues)
  status         String   @default("PENDING") // PENDING | CALCULATED | VALIDATED | PAID
  calculatedAt   DateTime? // Date du calcul
  validatedAt    DateTime? // Date de validation
  paidAt         DateTime?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  payroll      Payroll       @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  staff        Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)
  salarySlip   SalarySlip?
  taxWithholdings TaxWithholding[]
  payments     SalaryPayment[]

  @@index([tenantId, academicYearId])
  @@index([payrollId])
  @@index([staffId])
  @@index([status])
  @@map("payroll_items")
}

model SalaryPayment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  payrollItemId  String
  staffId        String
  amount         Decimal  @db.Decimal(10, 2)
  paymentMethod  String   // BANK_TRANSFER, CASH, MOBILE_MONEY
  paymentDate    DateTime
  reference      String?
  status         String   @default("COMPLETED")
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  payrollItem  PayrollItem   @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  staff        Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId])
  @@index([staffId])
  @@index([payrollItemId])
  @@index([paymentDate])
  @@map("salary_payments")
}

// ============================================================================
// MODULE 5 - PERSONNEL, RH & PAIE - MODÈLES COMPLÉMENTAIRES
// ============================================================================

model OvertimeRecord {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  staffId        String
  date           DateTime @db.Date
  hours          Decimal  @db.Decimal(5, 2)
  validated      Boolean  @default(false)
  validatedBy    String?
  validatedAt    DateTime?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  staff        Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)
  validator    User?         @relation("OvertimeValidator", fields: [validatedBy], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([staffId])
  @@index([date])
  @@index([validated])
  @@map("overtime_records")
}

model StaffTraining {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  staffId        String
  title          String
  provider       String?
  dateCompleted  DateTime @db.Date
  description    String?
  certificatePath String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  staff        Staff         @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([staffId])
  @@index([dateCompleted])
  @@map("staff_trainings")
}

model SalarySlip {
  id             String   @id @default(uuid())
  payrollItemId  String   @unique
  receiptNumber  String   @unique
  period         String   // Format: YYYY-MM (période de paie)
  filePath       String?  // Chemin du PDF généré
  pdfGenerated   Boolean  @default(false) // PDF généré ou non
  pdfGeneratedAt DateTime? // Date de génération PDF
  content        String?  // Contenu JSON du bulletin (pour historique)
  issuedAt       DateTime @default(now())
  issuedBy       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  payrollItem PayrollItem @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  issuer      User?       @relation("SalarySlipIssuer", fields: [issuedBy], references: [id], onDelete: SetNull)

  @@index([receiptNumber])
  @@index([period])
  @@index([pdfGenerated])
  @@map("salary_slips")
}

// ============================================================================
// MODULE 5 - CNSS & DÉCLARATIONS SOCIALES
// ============================================================================

model EmployeeCNSS {
  id             String   @id @default(uuid())
  tenantId       String
  staffId        String   @unique
  cnssNumber     String?
  affiliationDate DateTime? @db.Date
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  staff  Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
  declarationLines CNSSDeclarationLine[]

  @@index([tenantId])
  @@index([staffId])
  @@index([cnssNumber])
  @@map("employee_cnss")
}

model CNSSRate {
  id             String   @id @default(uuid())
  countryCode    String   // BJ, etc.
  employeeRate   Decimal  @db.Decimal(5, 4) // Ex: 0.0450 pour 4.5%
  employerRate   Decimal  @db.Decimal(5, 4)
  salaryCeiling  Decimal? @db.Decimal(10, 2)
  effectiveFrom  DateTime @db.Date
  effectiveTo    DateTime? @db.Date
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([countryCode, effectiveFrom])
  @@index([countryCode])
  @@index([effectiveFrom])
  @@map("cnss_rates")
}

model CNSSDeclaration {
  id                 String   @id @default(uuid())
  tenantId            String
  academicYearId      String
  month               String   // Format: YYYY-MM
  totalEmployeeShare  Decimal  @default(0) @db.Decimal(10, 2)
  totalEmployerShare  Decimal  @default(0) @db.Decimal(10, 2)
  totalAmount         Decimal  @db.Decimal(10, 2)
  status              String   @default("DRAFT") // DRAFT | DECLARED | PAID | LATE
  declaredAt          DateTime?
  paidAt              DateTime?
  paymentReference    String?
  paymentProofPath    String?
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  lines        CNSSDeclarationLine[]

  @@unique([tenantId, academicYearId, month])
  @@index([tenantId, academicYearId])
  @@index([status])
  @@index([month])
  @@map("cnss_declarations")
}

model CNSSDeclarationLine {
  id                 String   @id @default(uuid())
  cnssDeclarationId  String
  employeeCNSSId     String
  grossSalary        Decimal  @db.Decimal(10, 2)
  employeeShare      Decimal  @db.Decimal(10, 2)
  employerShare      Decimal  @db.Decimal(10, 2)
  createdAt          DateTime @default(now())

  cnssDeclaration CNSSDeclaration @relation(fields: [cnssDeclarationId], references: [id], onDelete: Cascade)
  employeeCNSS    EmployeeCNSS    @relation(fields: [employeeCNSSId], references: [id], onDelete: Cascade)

  @@index([cnssDeclarationId])
  @@index([employeeCNSSId])
  @@map("cnss_declaration_lines")
}

// ============================================================================
// MODULE 5 - FISCALITÉ & RETENUES (IRPP & ASSIMILÉS)
// ============================================================================

/**
 * Barèmes de taux d'impôt (IRPP/IUTS) par pays
 * Géré par policy pays, jamais codé en dur
 */
model TaxRate {
  id             String   @id @default(uuid())
  countryCode    String   // BJ, etc.
  taxType        String   @default("IRPP") // IRPP | IUTS | OTHER
  bracketMin     Decimal  @db.Decimal(10, 2) // Montant minimum de la tranche
  bracketMax     Decimal? @db.Decimal(10, 2) // Montant maximum (null = pas de limite)
  ratePercentage Decimal  @db.Decimal(5, 2) // Taux en pourcentage (ex: 15.50)
  fixedAmount    Decimal? @db.Decimal(10, 2) // Montant fixe si applicable
  effectiveFrom  DateTime @db.Date
  effectiveTo    DateTime? @db.Date // null = toujours actif
  isActive       Boolean  @default(true)
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  withholdings TaxWithholding[]

  @@unique([countryCode, taxType, bracketMin, effectiveFrom])
  @@index([countryCode, taxType])
  @@index([effectiveFrom, effectiveTo])
  @@index([isActive])
  @@map("tax_rates")
}

/**
 * Retenues fiscales appliquées aux salaires
 * Historisation complète pour audit
 */
model TaxWithholding {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  payrollItemId  String
  staffId        String
  taxRateId      String?  // Référence au barème utilisé
  taxType        String   @default("IRPP") // IRPP | IUTS | OTHER
  taxableAmount  Decimal  @db.Decimal(10, 2) // Montant imposable
  bracketMin     Decimal? @db.Decimal(10, 2) // Tranche utilisée
  bracketMax     Decimal? @db.Decimal(10, 2) // Tranche utilisée
  ratePercentage Decimal? @db.Decimal(5, 2) // Taux appliqué
  fixedAmount    Decimal? @db.Decimal(10, 2) // Montant fixe appliqué
  withheldAmount Decimal  @db.Decimal(10, 2) // Montant retenu
  calculationDetails Json? // Détails du calcul (pour audit)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  payrollItem  PayrollItem  @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  taxRate      TaxRate?     @relation(fields: [taxRateId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([payrollItemId])
  @@index([staffId])
  @@index([taxType])
  @@index([taxRateId])
  @@map("tax_withholdings")
}

// ============================================================================
// PLANNING & STUDIES
// ============================================================================

model RoomReservation {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  roomId         String
  reservedBy     String?
  reservationDate DateTime
  startTime      DateTime
  endTime        DateTime
  purpose        String?
  status         String   @default("CONFIRMED") // CONFIRMED, CANCELLED, COMPLETED
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  room         Room         @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId])
  @@index([roomId])
  @@index([reservationDate])
  @@map("room_reservations")
}

// ============================================================================
// MODULE 2 - SALLES & INFRASTRUCTURES
// Allocation des salles (liens avec classes, examens, événements)
// ============================================================================

model RoomAllocation {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  roomId         String
  allocationType String   // CLASS | EXAM | EVENT
  referenceId    String?  // ID de la classe, examen ou événement
  startTime      DateTime
  endTime        DateTime
  status         String   @default("ACTIVE") // ACTIVE | CANCELLED | COMPLETED
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  room         Room         @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId])
  @@index([roomId])
  @@index([allocationType])
  @@index([startTime, endTime])
  @@map("room_allocations")
}

model SubjectAssignment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  subjectId      String
  teacherId      String?
  classId        String?
  hoursPerWeek   Int?
  coefficient    Float?
  status         String   @default("ACTIVE")
  startDate      DateTime
  endDate        DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher      Teacher?     @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([subjectId])
  @@index([teacherId])
  @@map("subject_assignments")
}

model Timetable {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  name           String
  description    String?
  isActive       Boolean  @default(true)
  startDate      DateTime
  endDate        DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  entries      TimetableEntry[]
  versions     TimetableVersion[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([isActive])
  @@map("timetables")
}

model TimetableEntry {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  timetableId    String
  classId        String?
  subjectId      String?
  teacherId      String?
  roomId         String?
  dayOfWeek      Int      // 0 = Monday, 6 = Sunday
  startTime      String   // Format: HH:mm
  endTime        String   // Format: HH:mm
  duration       Int?     // Durée en minutes
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  timetable    Timetable    @relation(fields: [timetableId], references: [id], onDelete: Cascade)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject      Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  teacher      Teacher?     @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  room         Room?        @relation(fields: [roomId], references: [id], onDelete: SetNull)
  timeSlot     TimeSlot?    @relation(fields: [timeSlotId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([timetableId])
  @@index([dayOfWeek])
  @@map("timetable_entries")
}

// ============================================================================
// PEDAGOGICAL SHEETS & JOURNALS
// ============================================================================

model PedagogicalSheet {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  classId        String?
  subjectId      String?
  title          String
  description    String?
  content        String   // Contenu de la fiche (HTML, Markdown, etc.)
  status         String   @default("DRAFT") // DRAFT, SUBMITTED, VALIDATED, REJECTED
  submittedAt   DateTime?
  validatedAt   DateTime?
  validatedBy   String?
  rejectionReason String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject      Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  versions     PedagogicalSheetVersion[]
  validations  PedagogicalSheetValidation[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([status])
  @@map("pedagogical_sheets")
}

model PedagogicalSheetVersion {
  id                String   @id @default(uuid())
  tenantId          String
  academicYearId    String
  schoolLevelId      String
  pedagogicalSheetId String
  versionNumber      Int
  content            String
  changes            String?  // Description des changements
  createdBy          String?
  createdAt          DateTime @default(now())

  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear     AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel      SchoolLevel      @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  pedagogicalSheet PedagogicalSheet @relation(fields: [pedagogicalSheetId], references: [id], onDelete: Cascade)

  @@unique([pedagogicalSheetId, versionNumber])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("pedagogical_sheet_versions")
}

model PedagogicalSheetValidation {
  id                String   @id @default(uuid())
  tenantId          String
  academicYearId    String
  schoolLevelId      String
  pedagogicalSheetId String
  validatorId       String?
  status            String   // APPROVED, REJECTED
  comments          String?
  validatedAt       DateTime @default(now())

  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear     AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel      SchoolLevel      @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  pedagogicalSheet PedagogicalSheet @relation(fields: [pedagogicalSheetId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([pedagogicalSheetId])
  @@map("pedagogical_sheet_validations")
}

// ============================================================================
// MODULE 2 - SYSTÈME DE WORKFLOW PÉDAGOGIQUE
// ============================================================================

/**
 * Modèle unifié pour tous les documents pédagogiques
 * Fiches pédagogiques, Cahiers journaux, Cahiers de textes, Semainier
 */
model PedagogicalDocument {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  teacherId      String?  // Enseignant créateur
  classId        String?
  subjectId      String?
  documentType   String   // FICHE_PEDAGOGIQUE | CAHIER_JOURNAL | CAHIER_TEXTE | SEMAINIER
  title          String
  description    String?
  content        String   // Contenu structuré (JSON ou HTML)
  period         String?  // Période/semaine concernée (format: YYYY-WW ou YYYY-MM)
  weekStartDate  DateTime? @db.Date // Date début semaine (pour semainier)
  weekEndDate    DateTime? @db.Date // Date fin semaine (pour semainier)
  status         String   @default("DRAFT") // DRAFT | SUBMITTED | APPROVED | REJECTED | ACKNOWLEDGED
  submittedAt    DateTime?
  validatedAt    DateTime?
  validatedBy    String?  // Directeur/validateur
  rejectionReason String?
  acknowledgedAt DateTime? // Pour cahier de textes (pas de rejet)
  acknowledgedBy String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  teacher      Teacher?     @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject      Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  validator    User?        @relation("PedagogicalDocumentValidator", fields: [validatedBy], references: [id], onDelete: SetNull)
  acknowledger User?        @relation("PedagogicalDocumentAcknowledger", fields: [acknowledgedBy], references: [id], onDelete: SetNull)
  reviews      PedagogicalDocumentReview[]
  comments     PedagogicalDocumentComment[]
  notifications PedagogicalDocumentNotification[]
  versions     PedagogicalDocumentVersion[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([teacherId])
  @@index([documentType])
  @@index([status])
  @@index([submittedAt])
  @@index([period])
  @@map("pedagogical_documents")
}

/**
 * Versions historiques des documents pédagogiques
 * Pour traçabilité complète
 */
model PedagogicalDocumentVersion {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  documentId     String
  versionNumber  Int
  content        String   // Contenu de cette version
  changes        String?  // Description des changements
  createdBy      String?  // Enseignant qui a créé cette version
  createdAt      DateTime @default(now())

  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear      @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel       @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  document     PedagogicalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  creator      User?             @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@unique([documentId, versionNumber])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([documentId])
  @@map("pedagogical_document_versions")
}

/**
 * Reviews/Validations par la direction
 * Un document peut avoir plusieurs reviews (commentaires par paragraphe)
 */
model PedagogicalDocumentReview {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  documentId     String
  reviewerId     String   // Directeur/validateur
  decision       String   // APPROVED | REJECTED
  comments       String?  // Commentaires généraux
  sectionComments Json?   // Commentaires par section/paragraphe
  reviewedAt     DateTime @default(now())

  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear      @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel       @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  document     PedagogicalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  reviewer     User              @relation("PedagogicalDocumentReviewer", fields: [reviewerId], references: [id], onDelete: Restrict)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([documentId])
  @@index([reviewerId])
  @@index([decision])
  @@map("pedagogical_document_reviews")
}

/**
 * Commentaires pédagogiques (bidirectionnels)
 * Enseignant ↔ Direction
 */
model PedagogicalDocumentComment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  documentId     String
  authorId       String   // Enseignant ou Direction
  authorRole     String   // TEACHER | DIRECTOR
  comment        String
  section        String?  // Section du document concernée (optionnel)
  isRead         Boolean  @default(false)
  readAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear      @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel       @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  document     PedagogicalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  author       User              @relation("PedagogicalDocumentCommentAuthor", fields: [authorId], references: [id], onDelete: Restrict)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([documentId])
  @@index([authorId])
  @@index([isRead])
  @@map("pedagogical_document_comments")
}

/**
 * Notifications pour le workflow pédagogique
 * Traçabilité complète des événements
 */
model PedagogicalDocumentNotification {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  documentId     String
  recipientId    String   // Enseignant ou Direction destinataire
  notificationType String // SUBMISSION | VALIDATION | REJECTION | COMMENT | REMINDER
  title          String
  message        String
  smsSent        Boolean  @default(false)
  smsSentAt      DateTime?
  whatsappSent   Boolean  @default(false)
  whatsappSentAt DateTime?
  emailSent      Boolean  @default(false)
  emailSentAt    DateTime?
  inAppRead      Boolean  @default(false)
  inAppReadAt    DateTime?
  createdAt      DateTime @default(now())

  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear      @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel       @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  document     PedagogicalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  recipient    User              @relation("PedagogicalDocumentNotificationRecipient", fields: [recipientId], references: [id], onDelete: Restrict)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([documentId])
  @@index([recipientId])
  @@index([notificationType])
  @@index([inAppRead])
  @@map("pedagogical_document_notifications")
}

/**
 * CAHIER DU SEMAINIER
 * Responsabilité tournante entre enseignants
 */
model WeeklyDutyAssignment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  teacherId      String   // Enseignant désigné
  weekStartDate  DateTime @db.Date
  weekEndDate    DateTime @db.Date
  weekNumber     Int      // Numéro de semaine (1-52)
  assignmentMode String   @default("AUTO") // AUTO | MANUAL
  assignedBy     String?  // User qui a fait la désignation (si manuelle)
  reason         String?  // Motif de changement exceptionnel (si manuelle)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  teacher      Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  assigner     User?        @relation(fields: [assignedBy], references: [id], onDelete: SetNull)
  semainier    WeeklySemainier?

  @@unique([tenantId, academicYearId, schoolLevelId, weekStartDate])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([teacherId])
  @@index([weekStartDate, weekEndDate])
  @@index([isActive])
  @@map("weekly_duty_assignments")
}

/**
 * Contenu du cahier du semainier
 * Rempli par l'enseignant désigné
 */
model WeeklySemainier {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  assignmentId   String   @unique
  weekStartDate  DateTime @db.Date
  weekEndDate    DateTime @db.Date
  content        String   // Contenu structuré (JSON avec incidents, observations, actions)
  status         String   @default("EN_COURS") // EN_COURS | SOUMIS | VALIDATED
  submittedAt    DateTime?
  validatedAt    DateTime?
  validatedBy    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  assignment   WeeklyDutyAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  validator    User?        @relation("WeeklySemainierValidator", fields: [validatedBy], references: [id], onDelete: SetNull)
  dailyEntries WeeklySemainierDailyEntry[]
  incidents    WeeklySemainierIncident[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([weekStartDate, weekEndDate])
  @@index([status])
  @@map("weekly_semainiers")
}

/**
 * Entrées quotidiennes du semainier
 * Pour traçabilité jour par jour
 */
model WeeklySemainierDailyEntry {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  semainierId    String
  date           DateTime @db.Date
  observations   String?  // Observations générales
  actions        String?  // Actions prises
  events         Json?    // Événements importants
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  semainier    WeeklySemainier @relation(fields: [semainierId], references: [id], onDelete: Cascade)

  @@unique([semainierId, date])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([semainierId])
  @@index([date])
  @@map("weekly_semainier_daily_entries")
}

/**
 * Incidents enregistrés dans le semainier
 * Pour suivi et remontée vers QHSE si nécessaire
 */
model WeeklySemainierIncident {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  semainierId    String
  date           DateTime @db.Date
  type           String   // ABSENCE | RETARD | DISCIPLINE | SECURITY | OTHER
  description    String
  severity       String   @default("LOW") // LOW | MEDIUM | HIGH | CRITICAL
  reportedBy     String   // Enseignant qui a signalé
  actions        String?  // Actions prises immédiatement
  escalatedToQHSE Boolean @default(false) // Escalade vers QHSE si critique
  escalatedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  semainier    WeeklySemainier @relation(fields: [semainierId], references: [id], onDelete: Cascade)
  reporter     User        @relation("WeeklySemainierIncidentReporter", fields: [reportedBy], references: [id], onDelete: Restrict)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([semainierId])
  @@index([date])
  @@index([type, severity])
  @@index([escalatedToQHSE])
  @@map("weekly_semainier_incidents")
}

model LessonJournal {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  teacherId      String?
  classId        String?
  subjectId      String?
  date           DateTime
  status         String   @default("DRAFT") // DRAFT, SUBMITTED, VALIDATED
  submittedAt    DateTime?
  validatedAt    DateTime?
  validatedBy    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  teacher      Teacher?     @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject      Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  entries      LessonJournalEntry[]
  validations  LessonJournalValidation[]

  @@unique([tenantId, academicYearId, schoolLevelId, teacherId, classId, subjectId, date])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("lesson_journals")
}

model LessonJournalEntry {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  journalId      String
  period         String?  // Matin, Après-midi, etc.
  topic          String
  objectives     String?
  activities     String?
  materials      String?
  homework       String?
  notes          String?
  order          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  journal      LessonJournal @relation(fields: [journalId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([journalId])
  @@map("lesson_journal_entries")
}

model LessonJournalValidation {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  journalId      String
  validatorId    String?
  status         String   // APPROVED, REJECTED
  comments       String?
  validatedAt    DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  journal      LessonJournal @relation(fields: [journalId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([journalId])
  @@map("lesson_journal_validations")
}

model LessonPlan {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  classId        String?
  subjectId      String?
  date           DateTime
  title          String
  content        String
  homework       String?
  attachments    String[] @default([])
  publishedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject      Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  assignments  LessonPlanAssignment[]
  homeworkEntries HomeworkEntry[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([date])
  @@map("lesson_plans")
}

model LessonPlanAssignment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  lessonPlanId   String
  classId        String?
  assignedAt     DateTime @default(now())
  dueDate        DateTime?
  createdAt      DateTime @default(now())

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  lessonPlan LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  class      Class?     @relation(fields: [classId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([lessonPlanId])
  @@map("lesson_plan_assignments")
}

// ============================================================================
// MODULE 2 - ORGANISATION PÉDAGOGIQUE & ÉTUDES
// ============================================================================

// Habilitations enseignants / matières
model TeacherSubject {
  id             String   @id @default(uuid())
  tenantId       String
  teacherId      String
  subjectId      String
  academicYearId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  teacher      Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)

  @@unique([teacherId, subjectId, academicYearId])
  @@index([tenantId, academicYearId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

// Affectations classes / matières
model ClassSubject {
  id             String   @id @default(uuid())
  tenantId       String
  classId        String
  subjectId      String
  academicYearId String
  weeklyHours    Int      @default(0) // Heures par semaine
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  class        Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  assignments  TeacherClassAssignment[]
  exams        Exam[]

  @@unique([classId, subjectId, academicYearId])
  @@index([tenantId, academicYearId])
  @@index([classId])
  @@index([subjectId])
  @@map("class_subjects")
}

// Affectations enseignants / classes / matières
model TeacherClassAssignment {
  id             String   @id @default(uuid())
  tenantId       String
  teacherId      String
  classSubjectId String
  academicYearId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  teacher      Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  classSubject ClassSubject @relation(fields: [classSubjectId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)

  @@unique([teacherId, classSubjectId, academicYearId])
  @@index([tenantId, academicYearId])
  @@index([teacherId])
  @@index([classSubjectId])
  @@map("teacher_class_assignments")
}

// Créneaux horaires
model TimeSlot {
  id             String   @id @default(uuid())
  tenantId       String
  dayOfWeek      Int      // 0 = Lundi, 6 = Dimanche
  startTime      String   // Format: HH:mm
  endTime        String   // Format: HH:mm
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  timetableEntries TimetableEntry[]

  @@unique([tenantId, dayOfWeek, startTime, endTime])
  @@index([tenantId])
  @@map("time_slots")
}

// Cahier journal (journal quotidien de l'enseignant)
model DailyLog {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  teacherId      String
  classId        String?
  date           DateTime @db.Date
  summary        String   // Résumé de la journée
  validated      Boolean  @default(false) // Validé par la direction
  validatedBy    String?
  validatedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  teacher      Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  validator    User?        @relation(fields: [validatedBy], references: [id], onDelete: SetNull)

  @@unique([tenantId, teacherId, classId, date])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([teacherId])
  @@index([date])
  @@map("daily_logs")
}

// Cahier de textes (devoirs et notes pour les élèves)
model ClassDiary {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  classSubjectId String
  date           DateTime @db.Date
  homework       String?  // Devoirs à faire
  notes          String?  // Notes pour les élèves
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  classSubject ClassSubject @relation(fields: [classSubjectId], references: [id], onDelete: Cascade)

  @@unique([classSubjectId, date])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([classSubjectId])
  @@index([date])
  @@map("class_diaries")
}

model HomeworkEntry {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  lessonPlanId   String?
  classId        String?
  subjectId      String?
  title          String
  description    String
  dueDate        DateTime
  maxScore       Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  lessonPlan   LessonPlan? @relation(fields: [lessonPlanId], references: [id], onDelete: SetNull)
  class        Class?      @relation(fields: [classId], references: [id], onDelete: SetNull)
  subject      Subject?    @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  submissions  HomeworkSubmission[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([dueDate])
  @@map("homework_entries")
}

model HomeworkSubmission {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  homeworkId     String
  studentId      String
  content        String?
  attachments    String[] @default([])
  submittedAt    DateTime @default(now())
  score          Float?
  maxScore       Float?
  feedback       String?
  gradedAt       DateTime?
  gradedBy       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  homework     HomeworkEntry @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, studentId])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("homework_submissions")
}

// ============================================================================
// EXAMS & EVALUATION
// ============================================================================

model ExamSession {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  name           String
  description    String?
  startDate      DateTime
  endDate        DateTime
  status         String   @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  exams        Exam[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([status])
  @@map("exam_sessions")
}

model ExamSubject {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  examId         String
  subjectId      String
  classId        String?
  maxScore       Float    @default(20.0)
  coefficient    Float    @default(1.0)
  duration       Int?     // Durée en minutes
  examDate       DateTime?
  roomId         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  exam         Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject      Subject       @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  room         Room?         @relation(fields: [roomId], references: [id], onDelete: SetNull)

  @@unique([examId, subjectId])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("exam_subjects")
}

model ExamScore {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  examId         String
  studentId      String
  subjectId      String
  score          Float
  maxScore       Float
  coefficient    Float    @default(1.0)
  remarks        String?
  isValidated    Boolean  @default(false) // Validation obligatoire avant calcul
  validatedBy    String?
  validatedAt   DateTime?
  recordedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  exam         Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject      Subject       @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  validator    User?         @relation("ExamScoreValidator", fields: [validatedBy], references: [id], onDelete: SetNull)

  @@unique([examId, studentId, subjectId])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([isValidated])
  @@map("exam_scores")
}

model GradeCalculation {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  studentId      String
  subjectId      String?
  quarterId      String?
  calculationType String  // QUARTERLY, SEMESTER, ANNUAL
  rawAverage     Float
  weightedAverage Float
  finalGrade     Float?
  gradeRulesVersionId String?
  calculatedAt   DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject      Subject?      @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  quarter      Quarter?      @relation(fields: [quarterId], references: [id], onDelete: SetNull)
  gradeRules   GradeRulesVersion? @relation(fields: [gradeRulesVersionId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("grade_calculations")
}

model GradeRulesVersion {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  versionNumber  Int
  name           String
  rules          Json     // Règles de calcul (coefficients, pondérations, etc.)
  isActive       Boolean  @default(false)
  effectiveDate  DateTime
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  calculations GradeCalculation[]

  @@unique([tenantId, academicYearId, schoolLevelId, versionNumber])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("grade_rules_versions")
}

model ReportCard {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  studentId      String
  quarterId      String?
  type           String   // QUARTERLY, SEMESTER, ANNUAL
  overallAverage Float
  rank           Int?
  status         String   @default("DRAFT") // DRAFT, VALIDATED, PUBLISHED
  filePath       String?  // Chemin du PDF généré
  generatedAt    DateTime? // Date de génération du bulletin
  validatedAt    DateTime?
  validatedBy    String?
  publishedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  quarter      Quarter?      @relation(fields: [quarterId], references: [id], onDelete: SetNull)
  items        ReportCardItem[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([status])
  @@index([quarterId])
  @@map("report_cards")
}

model ReportCardItem {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  reportCardId   String
  subjectId      String
  average        Float
  coefficient    Float
  rank           Int?
  comments       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  reportCard   ReportCard   @relation(fields: [reportCardId], references: [id], onDelete: Cascade)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([reportCardId])
  @@map("report_card_items")
}

model Ranking {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  classId        String?
  quarterId      String?
  rankingType    String   // CLASS, LEVEL, GLOBAL
  studentId      String
  rank           Int
  average        Float
  totalStudents  Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  class        Class?        @relation(fields: [classId], references: [id], onDelete: SetNull)
  quarter      Quarter?      @relation(fields: [quarterId], references: [id], onDelete: SetNull)
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([tenantId, academicYearId, schoolLevelId, rankingType, classId, quarterId, studentId])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("rankings")
}

model HonorRoll {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  classId        String?
  quarterId      String?
  studentId      String
  mention        String   // EXCELLENT | TRES_BIEN | BIEN | ASSEZ_BIEN
  category       String?  // EXCELLENCE, HONOR, MERIT (pour compatibilité)
  average        Float
  rank           Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  class        Class?        @relation(fields: [classId], references: [id], onDelete: SetNull)
  quarter      Quarter?      @relation(fields: [quarterId], references: [id], onDelete: SetNull)
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([quarterId])
  @@map("honor_rolls")
}

model ClassCouncil {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  academicTrackId String?
  classId        String
  quarterId      String?
  councilDate    DateTime
  status         String   @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  participants   String[] @default([]) // IDs des participants
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  academicTrack AcademicTrack? @relation(fields: [academicTrackId], references: [id], onDelete: SetNull)
  class        Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  quarter      Quarter?     @relation(fields: [quarterId], references: [id], onDelete: SetNull)
  decisions    CouncilDecision[]
  minutes      CouncilMinute[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([classId])
  @@map("class_councils")
}

model CouncilDecision {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  councilId      String
  studentId      String?
  quarterId      String?  // Période concernée
  decision       String   // ADMIS | REDOUBLE | AJOURNE | CONDITIONAL
  decisionType   String?  // PROMOTION, REPEAT, CONDITIONAL, TRANSFER (pour compatibilité)
  description    String
  comments       String?  // Observations du conseil
  votesFor       Int?
  votesAgainst   Int?
  votesAbstain   Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  council      ClassCouncil @relation(fields: [councilId], references: [id], onDelete: Cascade)
  student      Student?     @relation(fields: [studentId], references: [id], onDelete: SetNull)
  quarter      Quarter?     @relation(fields: [quarterId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([quarterId])
  @@index([councilId])
  @@map("council_decisions")
}

model CouncilMinute {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  councilId      String
  content        String
  attachments    String[] @default([])
  recordedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  council      ClassCouncil @relation(fields: [councilId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([councilId])
  @@map("council_minutes")
}

model TimetableVersion {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  timetableId    String
  versionNumber  Int
  name           String?
  description    String?
  isActive       Boolean  @default(false)
  effectiveDate  DateTime
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  timetable    Timetable    @relation(fields: [timetableId], references: [id], onDelete: Cascade)

  @@unique([timetableId, versionNumber])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("timetable_versions")
}

// ============================================================================
// COMMUNICATION - ADDITIONAL MODELS
// ============================================================================

model MessageRecipient {
  id             String   @id @default(uuid())
  tenantId       String
  messageId      String
  recipientId    String
  recipientType  String   // USER | STUDENT | GUARDIAN | STAFF
  status         String   @default("PENDING") // PENDING | SENT | DELIVERED | READ | FAILED
  deliveredAt    DateTime?
  readAt         DateTime?
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, recipientId, recipientType])
  @@index([tenantId])
  @@index([recipientId])
  @@index([status])
  @@map("message_recipients")
}

// ============================================================================
// MODULE 6 — COMMUNICATION & ENGAGEMENT
// ============================================================================

/**
 * Canaux de communication (SMS, EMAIL, WHATSAPP, PUSH)
 */
model CommunicationChannel {
  id            String   @id @default(uuid())
  tenantId      String
  code          String   // SMS | EMAIL | WHATSAPP | PUSH
  name          String
  isActive      Boolean  @default(true)
  config        Json?    // Configuration spécifique au canal (API keys, etc.)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages      Message[]
  templates     MessageTemplate[]
  triggers      AutomatedTrigger[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@map("communication_channels")
}

/**
 * Cibles de messages (STUDENT, GUARDIAN, STAFF, CLASS, LEVEL)
 */
model MessageTarget {
  id            String   @id @default(uuid())
  messageId     String
  targetType    String   // STUDENT | GUARDIAN | STAFF | CLASS | LEVEL
  targetId      String
  createdAt     DateTime @default(now())

  message       Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, targetType, targetId])
  @@index([targetType, targetId])
  @@map("message_targets")
}

/**
 * Messages planifiés
 */
model ScheduledMessage {
  id            String   @id @default(uuid())
  messageId     String   @unique
  scheduledAt   DateTime
  status        String   @default("PENDING") // PENDING | SENT | FAILED | CANCELLED
  sentAt        DateTime?
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  message       Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([scheduledAt])
  @@index([status])
  @@map("scheduled_messages")
}

/**
 * Déclencheurs automatisés
 */
model AutomatedTrigger {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String?
  schoolLevelId  String?
  triggerType   String   // ABSENCE | IMPAYE | RETARD | INCIDENT | GRADE | EVENT
  channelId     String
  templateId    String?
  conditions    Json?    // Conditions pour le déclenchement
  isActive      Boolean  @default(true)
  lastTriggeredAt DateTime?
  triggerCount  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear  AcademicYear?     @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel   SchoolLevel?      @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  channel       CommunicationChannel @relation(fields: [channelId], references: [id], onDelete: Restrict)
  template      MessageTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([academicYearId])
  @@index([triggerType])
  @@index([isActive])
  @@map("automated_triggers")
}

/**
 * Logs détaillés des messages envoyés
 */
model MessageLog {
  id            String   @id @default(uuid())
  messageId     String
  recipient     String   // Email, téléphone, etc.
  recipientType String   // STUDENT | GUARDIAN | STAFF
  status        String   @default("PENDING") // DELIVERED | OPENED | FAILED | BOUNCED
  deliveredAt   DateTime?
  openedAt      DateTime?
  errorMessage  String?
  metadata      Json?
  createdAt     DateTime @default(now())

  message       Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([recipient])
  @@index([status])
  @@map("message_logs")
}

model MessageTemplate {
  id             String   @id @default(uuid())
  tenantId       String
  name           String
  type           String   // INFO | ALERT | REMINDER | DISCIPLINE | FINANCE
  channelId      String?
  subject        String?
  content        String
  contentFr      String?  // Contenu en français
  contentEn      String?  // Contenu en anglais
  variables      Json?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  channel   CommunicationChannel? @relation(fields: [channelId], references: [id], onDelete: SetNull)
  triggers  AutomatedTrigger[]

  @@index([tenantId, type])
  @@index([channelId])
  @@map("message_templates")
}

model SmsLog {
  id             String   @id @default(uuid())
  tenantId       String
  recipient      String
  message        String
  status         String
  provider       String?
  providerId     String?
  cost           Decimal? @db.Decimal(10, 2)
  sentAt         DateTime?
  deliveredAt    DateTime?
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("sms_logs")
}

model EmailLog {
  id             String   @id @default(uuid())
  tenantId       String
  recipient      String
  subject         String
  content         String
  status          String
  provider        String?
  providerId      String?
  sentAt          DateTime?
  deliveredAt     DateTime?
  bouncedAt       DateTime?
  errorMessage    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("email_logs")
}

model WhatsappLog {
  id             String   @id @default(uuid())
  tenantId       String
  recipient      String
  message        String
  status         String
  provider       String?
  providerId     String?
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("whatsapp_logs")
}

model PushNotification {
  id             String   @id @default(uuid())
  tenantId       String
  recipientId    String
  recipientType  String
  title           String
  body            String
  data            Json?
  status          String
  sentAt          DateTime?
  deliveredAt     DateTime?
  errorMessage    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([recipientId])
  @@index([status])
  @@map("push_notifications")
}

model CommunicationStat {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  date           DateTime
  channel        String
  sent           Int      @default(0)
  delivered      Int      @default(0)
  failed         Int      @default(0)
  cost           Decimal? @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)

  @@unique([tenantId, academicYearId, schoolLevelId, date, channel])
  @@index([tenantId])
  @@index([date])
  @@map("communication_stats")
}

// ============================================================================
// SUPPLEMENTARY MODULES
// ============================================================================

// Bibliothèque
model LibraryBook {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  isbn           String?
  title          String
  author         String?
  publisher      String?
  publicationYear Int?
  category       String?
  location       String?
  totalCopies    Int      @default(1)
  availableCopies Int
  status         String   @default("AVAILABLE") // AVAILABLE, BORROWED, LOST, DAMAGED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  loans        LibraryLoan[]

  @@index([tenantId])
  @@index([isbn])
  @@index([status])
  @@map("library_books")
}

model LibraryLoan {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  bookId         String
  borrowerId     String   // Student ID or Staff ID
  borrowerType   String   // STUDENT, STAFF
  loanDate       DateTime @default(now())
  dueDate        DateTime
  returnDate     DateTime?
  status         String   @default("ACTIVE") // ACTIVE, RETURNED, OVERDUE, LOST
  fineAmount     Decimal? @db.Decimal(10, 2)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  book         LibraryBook  @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([bookId])
  @@index([borrowerId])
  @@index([status])
  @@map("library_loans")
}

// Laboratoire
model LabEquipment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  name           String
  category       String?
  serialNumber   String?
  location       String?
  status         String   @default("AVAILABLE") // AVAILABLE, IN_USE, MAINTENANCE, DAMAGED
  specifications Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  reservations LabReservation[]

  @@index([tenantId])
  @@index([status])
  @@map("lab_equipment")
}

model LabReservation {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  equipmentId    String
  reservedBy     String?
  reservationDate DateTime
  startTime      DateTime
  endTime        DateTime
  purpose        String?
  status         String   @default("CONFIRMED")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  equipment    LabEquipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([equipmentId])
  @@map("lab_reservations")
}

// Transport
model Vehicle {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  plateNumber    String   @unique
  make           String
  model          String
  year           Int?
  capacity       Int
  driverId       String?
  status         String   @default("ACTIVE") // ACTIVE, INACTIVE, MAINTENANCE
  insuranceExpiry DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  routes       Route[]
  assignments  TransportAssignment[]

  @@index([tenantId])
  @@index([plateNumber])
  @@map("vehicles")
}

model Route {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  vehicleId      String?
  name           String
  description    String?
  startLocation  String
  endLocation    String
  waypoints      Json?
  distance       Float?
  estimatedTime  Int?     // En minutes
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  vehicle      Vehicle?      @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  assignments  TransportAssignment[]

  @@index([tenantId, academicYearId])
  @@map("routes")
}

model TransportAssignment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  vehicleId      String?
  routeId        String?
  pickupLocation String?
  dropoffLocation String?
  status         String   @default("ACTIVE")
  startDate      DateTime
  endDate        DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  vehicle      Vehicle?     @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  route        Route?       @relation(fields: [routeId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("transport_assignments")
}

// Cantine
model CanteenMenu {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  date           DateTime
  mealType       String   // BREAKFAST, LUNCH, SNACK
  items          Json     // Liste des plats
  price          Decimal? @db.Decimal(10, 2)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  subscriptions CanteenSubscription[]

  @@unique([tenantId, academicYearId, date, mealType])
  @@index([tenantId, academicYearId])
  @@map("canteen_menus")
}

model CanteenSubscription {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  menuId         String?
  subscriptionType String // DAILY, WEEKLY, MONTHLY
  startDate      DateTime
  endDate        DateTime?
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  menu         CanteenMenu? @relation(fields: [menuId], references: [id], onDelete: SetNull)
  payments     CanteenPayment[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("canteen_subscriptions")
}

model CanteenPayment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  subscriptionId String
  amount         Decimal  @db.Decimal(10, 2)
  paymentDate    DateTime
  paymentMethod  String?
  status         String   @default("COMPLETED")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  subscription CanteenSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([subscriptionId])
  @@map("canteen_payments")
}

// Infirmerie
model MedicalRecord {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  recordType     String   // ALLERGY, CONDITION, MEDICATION, VACCINATION
  description    String
  severity       String?
  startDate      DateTime?
  endDate        DateTime?
  isActive       Boolean  @default(true)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  visits        MedicalVisit[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("medical_records")
}

model MedicalVisit {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  recordId       String?
  studentId      String
  visitDate      DateTime
  reason         String
  symptoms       String?
  diagnosis      String?
  treatment      String?
  medication     String?
  followUp       String?
  attendedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  record       MedicalRecord? @relation(fields: [recordId], references: [id], onDelete: SetNull)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@index([visitDate])
  @@map("medical_visits")
}

model Medication {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String
  name           String
  dosage         String
  frequency      String
  startDate      DateTime
  endDate        DateTime?
  prescribedBy   String?
  status         String   @default("ACTIVE")
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([studentId])
  @@map("medications")
}

// QHSE
model Inspection {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  inspectionType String   // HYGIENE | SECURITE | PEDAGOGIE | ADMIN
  inspectorName  String?
  inspectionDate DateTime
  summary        String?
  status         String   @default("PENDING") // PENDING | COMPLETED | FOLLOW_UP
  followUpDate   DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel    SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  incidents      Incident[]
  checklists     InspectionChecklist[]
  correctiveActions CorrectiveAction[]

  @@index([tenantId, academicYearId])
  @@index([inspectionType])
  @@index([inspectionDate])
  @@map("inspections")
}

model Incident {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  studentId      String?  // Peut être lié à un élève
  classId        String?  // Peut être lié à une classe
  inspectionId   String?
  incidentType   String   // HYGIENE | SECURITE | SANTE | DISCIPLINE | INFRA
  severity       String   @default("LOW") // LOW | MEDIUM | HIGH | CRITICAL
  description    String
  occurredAt     DateTime
  location       String?
  reportedByUserId String?
  status         String   @default("OPEN") // OPEN | IN_PROGRESS | CLOSED
  closedAt       DateTime?
  closedByUserId String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel     SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  student         Student?     @relation(fields: [studentId], references: [id], onDelete: SetNull)
  class           Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  inspection      Inspection?  @relation(fields: [inspectionId], references: [id], onDelete: SetNull)
  reportedBy      User?        @relation("IncidentReportedBy", fields: [reportedByUserId], references: [id], onDelete: SetNull)
  closedBy        User?        @relation("IncidentClosedBy", fields: [closedByUserId], references: [id], onDelete: SetNull)
  attachments     IncidentAttachment[]
  actions         IncidentAction[]

  @@index([tenantId, academicYearId])
  @@index([incidentType, severity])
  @@index([status])
  @@index([occurredAt])
  @@map("incidents")
}

model CorrectiveAction {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  inspectionId   String?
  incidentId    String?
  action         String
  assignedTo     String?
  dueDate        DateTime
  status         String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  inspection   Inspection?   @relation(fields: [inspectionId], references: [id], onDelete: SetNull)
  incident     Incident?     @relation(fields: [incidentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([status])
  @@map("corrective_actions")
}

// ============================================================================
// MODULE 7 — QHSE, INCIDENTS & CONFORMITÉ
// ============================================================================

/**
 * Pièces jointes d'incident
 */
model IncidentAttachment {
  id            String   @id @default(uuid())
  incidentId    String
  fileName      String
  filePath      String
  fileSize      Int?
  mimeType      String?
  uploadedBy    String?
  createdAt     DateTime @default(now())

  incident      Incident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@map("incident_attachments")
}

/**
 * Actions correctives pour les incidents
 */
model IncidentAction {
  id                  String   @id @default(uuid())
  incidentId          String
  actionDescription   String
  responsibleUserId   String?
  dueDate             DateTime
  status              String   @default("PENDING") // PENDING | DONE
  completedAt         DateTime?
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  incident            Incident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  responsible         User?     @relation("IncidentActionResponsible", fields: [responsibleUserId], references: [id], onDelete: SetNull)

  @@index([incidentId])
  @@index([status])
  @@index([dueDate])
  @@map("incident_actions")
}

/**
 * Checklists d'inspection
 */
model InspectionChecklist {
  id            String   @id @default(uuid())
  inspectionId  String
  itemLabel     String
  status        String   @default("PENDING") // COMPLIANT | NON_COMPLIANT | PENDING
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  inspection    Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([status])
  @@map("inspection_checklists")
}

/**
 * Exigences réglementaires
 */
model ComplianceRequirement {
  id            String   @id @default(uuid())
  tenantId      String
  code          String   // Code unique de l'exigence
  title         String
  description   String?
  category      String?  // HYGIENE | SECURITE | PEDAGOGIE | ADMIN | FINANCE
  mandatory     Boolean  @default(true)
  legalReference String? // Référence légale
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  records       ComplianceRecord[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([category])
  @@map("compliance_requirements")
}

/**
 * Enregistrements de conformité
 */
model ComplianceRecord {
  id                        String   @id @default(uuid())
  complianceRequirementId   String
  academicYearId            String?
  schoolLevelId             String?
  status                    String   @default("PENDING") // COMPLIANT | NON_COMPLIANT | PENDING
  evidencePath              String?  // Chemin vers la preuve (document, photo, etc.)
  validated                 Boolean  @default(false)
  validatedBy               String?
  validatedAt               DateTime?
  notes                     String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  requirement   ComplianceRequirement @relation(fields: [complianceRequirementId], references: [id], onDelete: Restrict)
  academicYear  AcademicYear?          @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel   SchoolLevel?           @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  validator     User?                  @relation("ComplianceRecordValidator", fields: [validatedBy], references: [id], onDelete: SetNull)

  @@unique([complianceRequirementId, academicYearId, schoolLevelId])
  @@index([complianceRequirementId])
  @@index([academicYearId])
  @@index([status])
  @@map("compliance_records")
}

/**
 * Alertes de risques
 */
model RiskAlert {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String?
  schoolLevelId  String?
  sourceType    String   // INCIDENT | AUDIT | COMPLIANCE | INSPECTION
  sourceId      String   // ID de la source (incident_id, inspection_id, etc.)
  riskLevel     String   @default("LOW") // LOW | MEDIUM | HIGH | CRITICAL
  message       String
  acknowledged  Boolean  @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear  AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel   SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  acknowledgedUser User?      @relation("RiskAlertAcknowledgedBy", fields: [acknowledgedBy], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([sourceType, sourceId])
  @@index([riskLevel])
  @@index([acknowledged])
  @@map("risk_alerts")
}

// ============================================================================
// QHSE+ GOUVERNANCE, RISQUES & CONFORMITÉ (SOCLE TRANSVERSAL)
// ============================================================================

model QhsIncident {
  id               String   @id @default(uuid())
  tenantId         String
  academicYearId   String
  schoolLevelId    String?
  sourceModule     String   // SCOLARITE, FINANCE, RH, DISCIPLINE, SECURITE, AUTRE
  category         String   // ADMINISTRATIF, PEDAGOGIQUE, FINANCIER, RH, DISCIPLINAIRE, SECURITE
  type             String   // Type métier précis (ex: RETARD_PAIEMENT, INCIDENT_CLASSE, INCIDENT_TRANSPORT)
  gravity          String   // MINEUR, MAJEUR, CRITIQUE
  status           String   @default("OUVERT") // OUVERT, EN_COURS, CLOTURE
  title            String
  description      String
  location         String?
  relatedResourceType String? // STUDENT, STAFF, INVOICE, CLASS, EXAM, etc.
  relatedResourceId   String?
  createdById      String?
  validatedById    String?
  validatedAt      DateTime?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  createdBy    User?        @relation("QhsIncidentCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  validatedBy  User?        @relation("QhsIncidentValidatedBy", fields: [validatedById], references: [id], onDelete: SetNull)
  decisions    QhsDecisionLog[]
  correctiveActions QhsCorrectiveAction[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([sourceModule, category])
  @@index([status, gravity])
  @@map("qhs_incidents")
}

model QhsDecisionLog {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  incidentId     String
  decidedById    String?
  decidedAt      DateTime @default(now())
  decisionType   String   // MESURE_DISCIPLINAIRE, INFORMATION_PARENTS, SUSPENSION, etc.
  summary        String
  details        String?
  metadata       Json?

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  incident     QhsIncident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  decidedBy    User?        @relation(fields: [decidedById], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([incidentId])
  @@map("qhs_decision_logs")
}

model QhsCorrectiveAction {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  incidentId     String
  action         String
  ownerId        String?
  dueDate        DateTime
  status         String   @default("PENDING") // PENDING, EN_COURS, TERMINEE
  completedAt    DateTime?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  incident     QhsIncident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  owner        User?        @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([incidentId])
  @@index([status])
  @@map("qhs_corrective_actions")
}

model QhsAudit {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  auditType      String   // ADMINISTRATIF, PEDAGOGIQUE, FINANCIER, QHSE, RH
  scope          String?  // ETABLISSEMENT, NIVEAU, CYCLE, SERVICE, etc.
  date           DateTime
  auditor        String?
  status         String   @default("EN_COURS") // EN_COURS, CLOTURE
  globalResult   String?  // CONFORME, NON_CONFORME, A_SURVEILLER
  checklist      Json?    // Liste structurée des points de contrôle et résultats
  recommendations String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([auditType, status])
  @@map("qhs_audits")
}

model QhsRiskRegister {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  code           String
  title          String
  description    String?
  domain         String   // PEDAGOGIQUE, FINANCIER, RH, QHSE, STRATEGIQUE
  probability    Int      // 1 à 5
  impact         Int      // 1 à 5
  level          Int      // probabilité * impact
  status         String   @default("ACTIF") // ACTIF, MITIGE, CLOTURE
  ownerId        String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  owner        User?        @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  @@unique([tenantId, academicYearId, code])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([domain, status])
  @@map("qhs_risk_register")
}

// Boutique
model Product {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  name           String
  description    String?
  category       String?
  price          Decimal  @db.Decimal(10, 2)
  stock          Int      @default(0)
  sku            String?
  imageUrl       String?
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  orderItems   OrderItem[]

  @@index([tenantId])
  @@index([sku])
  @@map("products")
}

model Order {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  studentId      String?
  orderNumber    String   @unique
  totalAmount    Decimal  @db.Decimal(10, 2)
  status         String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, CANCELLED
  orderDate      DateTime @default(now())
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  student      Student?     @relation(fields: [studentId], references: [id], onDelete: SetNull)
  items        OrderItem[]
  payments     StorePayment[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  orderId        String
  productId      String
  quantity       Int
  unitPrice      Decimal  @db.Decimal(10, 2)
  totalPrice     Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([orderId])
  @@map("order_items")
}

model StorePayment {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  orderId        String
  amount         Decimal  @db.Decimal(10, 2)
  paymentMethod  String
  paymentDate    DateTime @default(now())
  status         String   @default("COMPLETED")
  reference      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([orderId])
  @@map("store_payments")
}

// EduCast
model MediaContent {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  title          String
  description    String?
  type           String   // VIDEO, AUDIO, DOCUMENT, IMAGE
  url            String
  thumbnailUrl   String?
  duration       Int?     // En secondes
  size           Int?     // En bytes
  category       String?
  isPublic       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  sessions     MediaSession[]

  @@index([tenantId])
  @@index([type])
  @@map("media_contents")
}

model MediaSession {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  contentId     String
  studentId      String?
  startTime      DateTime @default(now())
  endTime        DateTime?
  status         String   @default("ACTIVE") // ACTIVE, COMPLETED, ABANDONED
  progress       Float?   // Pourcentage de progression
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  content      MediaContent  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  student      Student?     @relation(fields: [studentId], references: [id], onDelete: SetNull)
  views        MediaView[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([contentId])
  @@index([studentId])
  @@map("media_sessions")
}

model MediaView {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  sessionId      String
  timestamp      DateTime
  duration       Int?     // Durée de visualisation en secondes
  createdAt      DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  session      MediaSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([sessionId])
  @@map("media_views")
}

// ============================================================================
// AI - ORION & ATLAS
// ============================================================================

model KpiDefinition {
  id             String   @id @default(uuid())
  tenantId       String?
  code           String   // Code unique du KPI (ex: TAUX_ABSENCE, TAUX_IMPAYE)
  name           String
  description    String?
  scope          String   @default("TENANT") // STUDENT | CLASS | LEVEL | TENANT
  category       String?  // PEDAGOGICAL, FINANCIAL, OPERATIONAL, RH, QHSE
  unit           String?  // %, XOF, nombre, etc.
  formula        String?  // Formule SQL ou description du calcul
  isSystem       Boolean  @default(false) // KPI système vs KPI personnalisé
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant?       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  snapshots    KpiSnapshot[]

  @@unique([tenantId, code])
  @@index([scope])
  @@index([category])
  @@map("kpi_definitions")
}

model KpiSnapshot {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  kpiId          String
  value          Float
  period         String?  // Format: YYYY-MM ou YYYY-MM-DD (optionnel)
  metadata       Json?
  computedAt     DateTime @default(now())
  createdAt      DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  kpi          KpiDefinition @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  @@unique([kpiId, tenantId, academicYearId, schoolLevelId, period])
  @@index([tenantId, academicYearId])
  @@index([kpiId])
  @@index([computedAt])
  @@map("kpi_snapshots")
}

// ============================================================================
// KPI OBJECTIVES (PILOTAGE DIRECTIONNEL)
// ============================================================================

model KpiObjective {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String?
  kpiId          String
  period         String   // YYYY, YYYY-MM, YYYY-MM-DD
  targetValue    Float
  minAcceptable  Float?
  maxAcceptable  Float?
  status         String   @default("ACTIVE") // ACTIVE, INACTIVE
  createdById    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  kpi          KpiDefinition @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([kpiId, period])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@map("kpi_objectives")
}

model OrionAlert {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  alertType      String   // FINANCIAL | PEDAGOGIC | RH | QHSE | OPERATIONAL
  severity       String   // INFO | WARNING | CRITICAL
  title          String
  description    String
  recommendation String?
  message        String?  // Message court pour affichage
  acknowledged   Boolean  @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  acknowledgedUser User?      @relation("OrionAlertAcknowledgedBy", fields: [acknowledgedBy], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([alertType])
  @@index([severity])
  @@index([acknowledged])
  @@index([createdAt])
  @@map("orion_alerts")
}

model OrionReport {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  reportType     String   // EXECUTIVE, DETAILED, COMPARATIVE
  title           String
  content         String   // Contenu du rapport (HTML, Markdown, etc.)
  period          String?
  generatedAt     DateTime @default(now())
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([reportType])
  @@map("orion_reports")
}

// ============================================================================
// MODULE 8 — PILOTAGE DIRECTION & IA ORION
// ============================================================================

/**
 * Insights et conseils ORION
 */
model OrionInsight {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  category       String   // FINANCE | PEDAGOGIE | RH | RISQUE | OPERATIONAL
  title          String
  content        String   // Contenu de l'insight (synthèse, conseil, etc.)
  priority       String   @default("LOW") // LOW | MEDIUM | HIGH
  sourceData     Json?    // Données sources qui ont généré cet insight
  isRead         Boolean  @default(false)
  readAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([category])
  @@index([priority])
  @@index([isRead])
  @@index([createdAt])
  @@map("orion_insights")
}

/**
 * Logs d'audit ORION (qui a accédé à quoi)
 */
model OrionAuditLog {
  id             String   @id @default(uuid())
  tenantId       String
  userId         String?
  action         String   // VIEW_KPI | VIEW_ALERT | VIEW_INSIGHT | EXPORT_REPORT
  resourceType   String?  // KPI | ALERT | INSIGHT | REPORT | DASHBOARD
  resourceId     String?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User?  @relation("OrionAuditLogUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("orion_audit_logs")
}

// ============================================================================
// AUTOMATISATION & SCÉNARIOS
// ============================================================================

model AutomationRule {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  name           String
  code           String
  scope          String   // FINANCE, PRESENCE, DOCUMENTS, QHSE, RH, PEDAGOGIE, GENERAL
  description    String?
  condition      Json     // DSL métier: champs, opérateurs, valeurs
  action         Json     // Actions: notifications, création d'incident QHSE, tasks, etc.
  isActive       Boolean  @default(true)
  createdById    String?
  approvedById   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  createdBy    User?        @relation("AutomationRuleCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  approvedBy   User?        @relation("AutomationRuleApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  executions   AutomationExecution[]

  @@unique([tenantId, code])
  @@index([tenantId, scope, isActive])
  @@map("automation_rules")
}

model AutomationExecution {
  id             String   @id @default(uuid())
  tenantId       String
  ruleId         String
  triggeredAt    DateTime @default(now())
  status         String   @default("SUCCESS") // SUCCESS, FAILED, SKIPPED
  inputPayload   Json?
  actionPayload  Json?
  errorMessage   String?
  createdAt      DateTime @default(now())

  tenant Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rule   AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([tenantId, triggeredAt])
  @@index([ruleId, status])
  @@map("automation_executions")
}

model AtlasConversation {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  userId         String
  title          String?
  status         String   @default("ACTIVE") // ACTIVE, ARCHIVED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages     AtlasMessage[]

  @@index([tenantId])
  @@index([userId])
  @@map("atlas_conversations")
}

model AtlasMessage {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  conversationId String
  role           String   // USER, ASSISTANT
  content        String
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  conversation AtlasConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([conversationId])
  @@map("atlas_messages")
}

model AtlasFeedback {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  messageId      String?
  conversationId String?
  rating         Int?     // 1-5
  comment        String?
  createdAt      DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  message      AtlasMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  conversation AtlasConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@map("atlas_feedback")
}

// ============================================================================
// OFFLINE & SYNCHRONIZATION
// ============================================================================

model SyncOperation {
  id             String   @id @default(uuid())
  tenantId       String
  operationType  String   // UPLOAD, DOWNLOAD, FULL_SYNC
  status         String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  recordsCount   Int?
  errorMessage   String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conflicts SyncConflict[]
  logs      SyncLog[]

  @@index([tenantId])
  @@index([status])
  @@map("sync_operations")
}

model SyncConflict {
  id             String   @id @default(uuid())
  tenantId       String
  operationId    String
  tableName      String
  recordId       String
  localData      Json
  remoteData     Json
  resolution     String?  // LOCAL, REMOTE, MANUAL
  resolvedBy     String?
  resolvedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  operation SyncOperation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([operationId])
  @@map("sync_conflicts")
}

model SyncLog {
  id             String   @id @default(uuid())
  tenantId       String
  operationId    String
  level          String   // INFO, WARNING, ERROR
  message        String
  details        Json?
  createdAt      DateTime @default(now())

  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  operation SyncOperation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([operationId])
  @@index([level])
  @@map("sync_logs")
}

// ============================================================================
// MODULE PATRONAT & EXAMENS NATIONAUX
// ============================================================================
// 
// Module institutionnel pour l'organisation des examens nationaux
// Isolation métier par naming (patronat_*, exam_*, question_bank_*)
// Séparation par tenant.type = 'PATRONAT'
// Relations avec écoles existantes via tables de liaison
// ============================================================================

// ----------------------------------------------------------------------------
// PATRONAT - ENTITÉ PRINCIPALE
// ----------------------------------------------------------------------------

model Patronat {
  id                String   @id @default(uuid())
  tenantId          String   @unique // Un patronat = un tenant PATRONAT
  name              String
  abbreviation      String?
  legalName         String?
  registrationNumber String? // Numéro d'enregistrement officiel
  address           String?
  primaryPhone      String?
  primaryEmail      String?
  website           String?
  logo              String?
  region            String?  // Région ou département
  scope             String   @default("DEPARTMENTAL") // DEPARTMENTAL, REGIONAL, NATIONAL
  status            String   @default("ACTIVE") // ACTIVE, SUSPENDED, INACTIVE
  metadata          Json?    // Données additionnelles
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users             PatronatUser[]
  schools           PatronatSchool[]
  exams             NationalExam[]
  questionBankResources QuestionBankResource[]

  @@index([tenantId])
  @@index([region])
  @@index([status])
  @@map("patronats")
}

// ----------------------------------------------------------------------------
// UTILISATEURS PATRONAT
// ----------------------------------------------------------------------------

model PatronatUser {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  userId            String   // User existant
  role              String   // PATRONAT_ADMIN, PATRONAT_OPERATOR, EXAM_SUPERVISOR, EXAM_VIEWER
  permissions       String[] @default([]) // Permissions granulaires
  isActive          Boolean  @default(true)
  assignedRegions   String[] @default([]) // Régions/départements assignés
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator           User?    @relation("PatronatUserCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@index([role])
  @@map("patronat_users")
}

// ----------------------------------------------------------------------------
// ÉCOLES RATTACHÉES AU PATRONAT
// ----------------------------------------------------------------------------

model PatronatSchool {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  schoolTenantId    String   // Tenant SCHOOL (référence à un tenant existant)
  academicYearId    String   // Année scolaire
  status            String   @default("PENDING") // PENDING, ACTIVE, SUSPENDED, REJECTED
  invitationToken   String?  @unique // Token pour invitation
  invitedAt         DateTime?
  joinedAt          DateTime?
  suspendedAt       DateTime?
  suspendedBy       String?
  suspendedReason   String?
  accessLevel       String   @default("READ_ONLY") // READ_ONLY, FULL_ACCESS
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenant            Tenant        @relation("PatronatSchools", fields: [tenantId], references: [id], onDelete: Cascade)
  schoolTenant      Tenant        @relation("SchoolTenants", fields: [schoolTenantId], references: [id], onDelete: Restrict)
  academicYear      AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  creator           User?         @relation("PatronatSchoolCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  suspender         User?         @relation("PatronatSchoolSuspender", fields: [suspendedBy], references: [id], onDelete: SetNull)
  candidates        ExamCandidate[]

  @@unique([tenantId, schoolTenantId, academicYearId])
  @@index([tenantId])
  @@index([schoolTenantId])
  @@index([academicYearId])
  @@index([status])
  @@map("patronat_schools")
}

// ----------------------------------------------------------------------------
// EXAMENS NATIONAUX
// ----------------------------------------------------------------------------

model NationalExam {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  code              String   // CEP, BEPC, BAC, etc.
  name              String
  description       String?
  examType          String   // CEP, BEPC, BAC, CONCOURS, etc.
  level             String   // PRIMAIRE, SECONDAIRE
  startDate         DateTime
  endDate           DateTime
  registrationStartDate DateTime
  registrationEndDate   DateTime
  status            String   @default("DRAFT") // DRAFT, REGISTRATION_OPEN, REGISTRATION_CLOSED, IN_PROGRESS, COMPLETED, CANCELLED
  totalCandidates   Int      @default(0)
  totalCenters      Int      @default(0)
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("NationalExamAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  creator           User?         @relation("NationalExamCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  centers           ExamCenter[]
  candidates        ExamCandidate[]
  subjects          NationalExamSubject[]
  results           ExamResult[]
  documents         ExamDocument[]

  @@unique([tenantId, academicYearId, code])
  @@index([tenantId])
  @@index([academicYearId])
  @@index([code])
  @@index([status])
  @@index([startDate])
  @@map("national_exams")
}

// ----------------------------------------------------------------------------
// CENTRES D'EXAMEN
// ----------------------------------------------------------------------------

model ExamCenter {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  examId            String   // NationalExam
  code              String   // Code unique du centre
  name              String
  address           String?
  location          Json?    // Coordonnées GPS
  capacity          Int      @default(0) // Capacité totale
  totalRooms        Int      @default(0)
  status            String   @default("ACTIVE") // ACTIVE, SUSPENDED, CLOSED
  contactName       String?
  contactPhone      String?
  contactEmail      String?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("ExamCenterAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  exam              NationalExam  @relation(fields: [examId], references: [id], onDelete: Cascade)
  creator           User?         @relation("ExamCenterCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  rooms              ExamRoom[]
  candidates         ExamCandidate[]
  supervisors        ExamSupervisor[]

  @@unique([tenantId, academicYearId, examId, code])
  @@index([tenantId])
  @@index([academicYearId])
  @@index([examId])
  @@index([code])
  @@index([status])
  @@map("exam_centers")
}

// ----------------------------------------------------------------------------
// CANDIDATS AUX EXAMENS
// ----------------------------------------------------------------------------

model ExamCandidate {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  examId            String   // NationalExam
  patronatSchoolId String?  // École d'origine (si rattachée)
  schoolTenantId    String?  // Tenant école (si école existante)
  centerId          String?  // Centre d'examen assigné
  roomId            String?  // Salle assignée
  registrationNumber String  @unique // Numéro d'inscription unique
  matricule         String   @unique // Matricule candidat
  tableNumber       String?  // Numéro de table
  firstName         String
  lastName          String
  dateOfBirth       DateTime?
  gender            String?  // M, F
  nationality       String?
  placeOfBirth      String?
  address           String?
  phone             String?
  email             String?
  photo             String?  // URL photo
  registrationDate  DateTime @default(now())
  status            String   @default("REGISTERED") // REGISTERED, CONFIRMED, ABSENT, DISQUALIFIED, PASSED, FAILED
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("ExamCandidateAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  exam              NationalExam  @relation(fields: [examId], references: [id], onDelete: Cascade)
  patronatSchool    PatronatSchool? @relation(fields: [patronatSchoolId], references: [id], onDelete: SetNull)
  schoolTenant      Tenant?       @relation("ExamCandidateSchoolTenant", fields: [schoolTenantId], references: [id], onDelete: SetNull)
  center            ExamCenter?   @relation(fields: [centerId], references: [id], onDelete: SetNull)
  room              ExamRoom?     @relation(fields: [roomId], references: [id], onDelete: SetNull)
  creator           User?         @relation("ExamCandidateCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  results           ExamResult[]
  documents         ExamDocument[]

  @@unique([tenantId, academicYearId, examId, registrationNumber])
  @@index([tenantId])
  @@index([academicYearId])
  @@index([examId])
  @@index([registrationNumber])
  @@index([matricule])
  @@index([tableNumber])
  @@index([status])
  @@index([centerId])
  @@map("exam_candidates")
}

// ----------------------------------------------------------------------------
// SALLES D'EXAMEN
// ----------------------------------------------------------------------------

model ExamRoom {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  examId            String   // NationalExam
  centerId         String   // ExamCenter
  code              String   // Code salle (ex: Salle A, Salle 1)
  name              String
  capacity          Int      @default(0)
  currentOccupancy  Int      @default(0)
  floor             Int?
  building          String?
  status            String   @default("AVAILABLE") // AVAILABLE, OCCUPIED, CLOSED
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("ExamRoomAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  exam              NationalExam  @relation("ExamRoomExam", fields: [examId], references: [id], onDelete: Cascade)
  center            ExamCenter    @relation(fields: [centerId], references: [id], onDelete: Cascade)
  creator           User?         @relation("ExamRoomCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  candidates        ExamCandidate[]
  supervisors       ExamSupervisor[]

  @@unique([tenantId, academicYearId, examId, centerId, code])
  @@index([tenantId])
  @@index([academicYearId])
  @@index([examId])
  @@index([centerId])
  @@index([code])
  @@index([status])
  @@map("exam_rooms")
}

// ----------------------------------------------------------------------------
// SURVEILLANTS D'EXAMEN
// ----------------------------------------------------------------------------

model ExamSupervisor {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  examId            String   // NationalExam
  centerId         String?  // ExamCenter (si assigné à un centre)
  roomId            String?  // ExamRoom (si assigné à une salle)
  userId            String?  // User existant (si utilisateur Academia Hub)
  firstName         String
  lastName          String
  email             String?
  phone             String?
  role              String   @default("SUPERVISOR") // SUPERVISOR, HEAD_SUPERVISOR, OBSERVER
  status            String   @default("ASSIGNED") // ASSIGNED, PRESENT, ABSENT, REPLACED
  assignedDate      DateTime @default(now())
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("ExamSupervisorAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  exam              NationalExam  @relation("ExamSupervisorExam", fields: [examId], references: [id], onDelete: Cascade)
  center            ExamCenter?   @relation(fields: [centerId], references: [id], onDelete: SetNull)
  room              ExamRoom?     @relation(fields: [roomId], references: [id], onDelete: SetNull)
  user              User?          @relation("ExamSupervisorUser", fields: [userId], references: [id], onDelete: SetNull)
  creator           User?          @relation("ExamSupervisorCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([academicYearId])
  @@index([examId])
  @@index([centerId])
  @@index([roomId])
  @@index([status])
  @@map("exam_supervisors")
}

// ----------------------------------------------------------------------------
// ÉPREUVES / MATIÈRES D'EXAMEN
// ----------------------------------------------------------------------------

model NationalExamSubject {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  examId            String   // NationalExam
  code              String   // Code matière (ex: MAT, FR, ANG, etc.)
  name              String
  description       String?
  coefficient       Float    @default(1.0)
  duration          Int?     // Durée en minutes
  maxScore          Float    @default(20.0)
  passingScore      Float?   // Note minimale pour valider
  examDate          DateTime?
  startTime         String?  // Heure de début (HH:mm)
  endTime           String?  // Heure de fin (HH:mm)
  order             Int      @default(0) // Ordre d'affichage
  status            String   @default("DRAFT") // DRAFT, SCHEDULED, IN_PROGRESS, COMPLETED
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("NationalExamSubjectAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  exam              NationalExam  @relation(fields: [examId], references: [id], onDelete: Cascade)
  creator           User?         @relation("NationalExamSubjectCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  results           ExamResult[]

  @@unique([tenantId, academicYearId, examId, code])
  @@index([tenantId])
  @@index([academicYearId])
  @@index([examId])
  @@index([code])
  @@index([examDate])
  @@map("national_exam_subjects")
}

// ----------------------------------------------------------------------------
// RÉSULTATS D'EXAMEN
// ----------------------------------------------------------------------------

model ExamResult {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  examId            String   // NationalExam
  candidateId       String   // ExamCandidate
  subjectId         String   // ExamSubject
  score             Float
  maxScore          Float    @default(20.0)
  coefficient       Float    @default(1.0)
  weightedScore     Float    // score * coefficient
  grade             String?  // Mention (TRÈS BIEN, BIEN, etc.)
  rank              Int?     // Classement dans la matière
  status            String   @default("DRAFT") // DRAFT, VALIDATED, PUBLISHED
  remarks           String?
  enteredBy         String?
  validatedBy       String?
  validatedAt       DateTime?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("ExamResultAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  exam              NationalExam  @relation(fields: [examId], references: [id], onDelete: Cascade)
  candidate         ExamCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  subject           NationalExamSubject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  enterer           User?         @relation("ExamResultEnterer", fields: [enteredBy], references: [id], onDelete: SetNull)
  validator         User?         @relation("ExamResultValidator", fields: [validatedBy], references: [id], onDelete: SetNull)

  @@unique([tenantId, academicYearId, examId, candidateId, subjectId])
  @@index([tenantId])
  @@index([academicYearId])
  @@index([examId])
  @@index([candidateId])
  @@index([subjectId])
  @@index([status])
  @@map("exam_results")
}

// ----------------------------------------------------------------------------
// DOCUMENTS D'EXAMEN
// ----------------------------------------------------------------------------

model ExamDocument {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  examId            String   // NationalExam
  candidateId       String?  // ExamCandidate (si document lié à un candidat)
  documentType      String   // LISTE_SURVEILLANCE, RELEVE_NOTES, ATTESTATION, CERTIFICAT, etc.
  title             String
  description       String?
  fileUrl           String
  fileSize          Int?
  mimeType          String?
  status            String   @default("DRAFT") // DRAFT, GENERATED, PUBLISHED, ARCHIVED
  generatedBy       String?
  generatedAt       DateTime?
  publishedBy       String?
  publishedAt       DateTime?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("ExamDocumentAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  exam              NationalExam  @relation(fields: [examId], references: [id], onDelete: Cascade)
  candidate         ExamCandidate? @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  generator         User?         @relation("ExamDocumentGenerator", fields: [generatedBy], references: [id], onDelete: SetNull)
  publisher         User?         @relation("ExamDocumentPublisher", fields: [publishedBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([academicYearId])
  @@index([examId])
  @@index([candidateId])
  @@index([documentType])
  @@index([status])
  @@map("exam_documents")
}

// ----------------------------------------------------------------------------
// BANQUE D'ÉPREUVES
// ----------------------------------------------------------------------------

model QuestionBankResource {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  academicYearId    String   // Année scolaire
  schoolLevelId     String?  // Niveau scolaire (optionnel)
  title             String
  description       String?
  resourceType      String   // EXAM_SUBJECT, PRACTICE_TEST, CORRECTION, etc.
  subject           String?  // Matière
  class             String?  // Classe
  examType          String?  // Type d'examen
  fileUrl           String
  fileSize          Int?
  mimeType          String?
  isPublic          Boolean  @default(false) // Accessible à toutes les écoles
  accessLevel       String   @default("RESTRICTED") // PUBLIC, RESTRICTED, PRIVATE
  uploadedBy        String?
  uploadedAt        DateTime @default(now())
  status            String   @default("ACTIVE") // ACTIVE, ARCHIVED, DELETED
  downloadCount     Int      @default(0)
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear      AcademicYear  @relation("QuestionBankAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel       SchoolLevel?  @relation("QuestionBankSchoolLevel", fields: [schoolLevelId], references: [id], onDelete: SetNull)
  uploader          User?         @relation("QuestionBankUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)
  accessLogs        ResourceAccessLog[]

  @@index([tenantId])
  @@index([academicYearId])
  @@index([schoolLevelId])
  @@index([resourceType])
  @@index([subject])
  @@index([isPublic])
  @@index([status])
  @@map("question_bank_resources")
}

// ----------------------------------------------------------------------------
// LOGS D'ACCÈS AUX RESSOURCES
// ----------------------------------------------------------------------------

model ResourceAccessLog {
  id                String   @id @default(uuid())
  tenantId          String   // Tenant PATRONAT
  resourceId        String   // QuestionBankResource
  accessedBy        String?  // User ID
  schoolTenantId    String?  // Tenant école (si accès depuis une école)
  accessType        String   // VIEW, DOWNLOAD, PREVIEW
  ipAddress         String?
  userAgent         String?
  accessedAt        DateTime @default(now())

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resource          QuestionBankResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user              User?               @relation("ResourceAccessUser", fields: [accessedBy], references: [id], onDelete: SetNull)
  schoolTenant      Tenant?              @relation("ResourceAccessSchoolTenant", fields: [schoolTenantId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([resourceId])
  @@index([accessedBy])
  @@index([schoolTenantId])
  @@index([accessType])
  @@index([accessedAt])
  @@map("resource_access_logs")
}

// ============================================================================
// AUDIT & COMPLIANCE
// ============================================================================

model ActivityLog {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String?
  schoolLevelId  String?
  userId         String?
  action         String
  resource       String?
  resourceId     String?
  details        Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  schoolLevel  SchoolLevel?  @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  user         User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================================================
// MODULE 4 - FINANCES & ÉCONOMAT
// ============================================================================

// ----------------------------------------------------------------------------
// CONFIGURATION DES FRAIS
// ----------------------------------------------------------------------------

model FeeCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  code        String?  // Code unique pour catégorie (ex: TUITION, REGISTRATION)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  feeDefinitions FeeDefinition[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("fee_categories")
}

model FeeDefinition {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  classId        String?  // Optionnel : frais spécifique à une classe
  feeCategoryId  String
  label          String
  amount         Decimal  @db.Decimal(10, 2)
  isMandatory    Boolean  @default(true)
  dueDate        DateTime? @db.Date
  description    String?
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  class        Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  feeCategory  FeeCategory  @relation(fields: [feeCategoryId], references: [id], onDelete: Restrict)
  creator      User?        @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  studentFees  StudentFee[]
  installments FeeInstallment[]

  feeRegimeRules FeeRegimeRule[]
  studentFeeProfiles StudentFeeProfile[]

  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([feeCategoryId])
  @@map("fee_definitions")
}

// ----------------------------------------------------------------------------
// RÉGIMES TARIFAIRES & PROFILS ÉLÈVES
// ----------------------------------------------------------------------------

/**
 * Régimes tarifaires (STANDARD, ENFANT_ENSEIGNANT, REDUCTION)
 * Permet de définir des barèmes différents par type d'élève
 */
model FeeRegime {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  code           String   // STANDARD | ENFANT_ENSEIGNANT | REDUCTION
  label          String
  description    String?
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  rules        FeeRegimeRule[]
  profiles     StudentFeeProfile[]

  @@unique([tenantId, academicYearId, schoolLevelId, code])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([code])
  @@map("fee_regimes")
}

/**
 * Règles de réduction par régime tarifaire
 * Définit les réductions appliquées aux différents types de frais
 */
model FeeRegimeRule {
  id            String   @id @default(uuid())
  feeRegimeId   String
  feeType       String   // INSCRIPTION | REINSCRIPTION | SCOLARITE
  discountType  String   // FIXED | PERCENT
  discountValue Decimal  @db.Decimal(10, 2) // Montant fixe ou pourcentage
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  feeRegime FeeRegime @relation(fields: [feeRegimeId], references: [id], onDelete: Cascade)

  @@unique([feeRegimeId, feeType])
  @@index([feeRegimeId])
  @@map("fee_regime_rules")
}

/**
 * Profil tarifaire d'un élève pour une année scolaire
 * Définit le régime tarifaire appliqué à un élève
 */
model StudentFeeProfile {
  id             String   @id @default(uuid())
  studentId      String
  academicYearId String
  feeRegimeId    String
  justification  String?  // Motif de la réduction (si applicable)
  validatedBy    String?   // Directeur / Admin qui a validé
  validatedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  feeRegime    FeeRegime    @relation(fields: [feeRegimeId], references: [id], onDelete: Restrict)
  validator    User?        @relation("StudentFeeProfileValidator", fields: [validatedBy], references: [id], onDelete: SetNull)

  @@unique([studentId, academicYearId])
  @@index([studentId])
  @@index([academicYearId])
  @@index([feeRegimeId])
  @@map("student_fee_profiles")
}

/**
 * Arriérés inter-années
 * Dettes reportées d'une année scolaire à l'autre
 * Ligne immuable, jamais supprimée
 */
model StudentArrear {
  id                String   @id @default(uuid())
  tenantId          String
  studentId         String
  fromAcademicYearId String  // Année d'origine de la dette
  toAcademicYearId  String   // Année de report
  amountDue         Decimal  @db.Decimal(10, 2)
  amountPaid        Decimal  @default(0) @db.Decimal(10, 2)
  balanceDue        Decimal  @db.Decimal(10, 2)
  status            String   @default("OPEN") // OPEN | PARTIAL | PAID
  generatedAt       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student           Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  fromAcademicYear  AcademicYear @relation("StudentArrearFromYear", fields: [fromAcademicYearId], references: [id], onDelete: Restrict)
  toAcademicYear    AcademicYear @relation("StudentArrearToYear", fields: [toAcademicYearId], references: [id], onDelete: Restrict)
  paymentAllocations PaymentAllocation[]

  @@index([tenantId])
  @@index([studentId])
  @@index([fromAcademicYearId])
  @@index([toAcademicYearId])
  @@index([status])
  @@map("student_arrears")
}

/**
 * Tranches de paiement pour les frais de scolarité
 * Permet de diviser la scolarité en plusieurs échéances
 */
model FeeInstallment {
  id                String   @id @default(uuid())
  feeDefinitionId   String
  installmentLabel  String   // "Tranche 1", "Tranche 2", etc.
  amount            Decimal  @db.Decimal(10, 2)
  dueDate           DateTime @db.Date
  orderIndex        Int      // Ordre de priorité de paiement
  isMandatory       Boolean  @default(true)
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  feeDefinition FeeDefinition @relation(fields: [feeDefinitionId], references: [id], onDelete: Cascade)

  @@index([feeDefinitionId])
  @@index([feeDefinitionId, orderIndex])
  @@map("fee_installments")
}

// ----------------------------------------------------------------------------
// FACTURATION & SCOLARITÉ
// ----------------------------------------------------------------------------

model StudentFee {
  id             String   @id @default(uuid())
  tenantId       String
  studentId      String
  feeDefinitionId String
  academicYearId String
  totalAmount    Decimal  @db.Decimal(10, 2)
  status         String   @default("NOT_STARTED") // NOT_STARTED | PARTIAL | PAID
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  feeDefinition FeeDefinition @relation(fields: [feeDefinitionId], references: [id], onDelete: Restrict)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  payments     Payment[]    @relation("StudentFeePayment")
  paymentSummary PaymentSummary?
  feeArrears   FeeArrear[]
  paymentAllocations PaymentAllocation[]

  @@unique([studentId, feeDefinitionId, academicYearId])
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@index([status])
  @@map("student_fees")
}

/**
 * Allocation automatique des paiements avec priorité
 * Permet de tracer comment un paiement est alloué aux différents frais
 * RÈGLE : Arriérés → Inscription/Réinscription → Scolarité par ordre de tranches
 */
model PaymentAllocation {
  id             String   @id @default(uuid())
  paymentId      String
  targetType     String   // ARREAR | STUDENT_FEE (INSCRIPTION | REINSCRIPTION | SCOLARITE)
  targetId       String   // ID de StudentArrear ou StudentFee (pour référence)
  studentFeeId   String?  // Optionnel : pour compatibilité rétroactive (si targetType = STUDENT_FEE)
  studentArrearId String? // Optionnel : pour relation Prisma (si targetType = ARREAR)
  allocatedAmount Decimal  @db.Decimal(10, 2)
  allocationOrder Int     // Ordre d'allocation (1 = priorité maximale : arriérés)
  notes          String?
  createdAt      DateTime @default(now())

  payment    Payment    @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  studentFee StudentFee? @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  studentArrear StudentArrear? @relation("PaymentAllocationArrear", fields: [studentArrearId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([targetType, targetId])
  @@index([studentFeeId])
  @@index([studentArrearId])
  @@index([paymentId, allocationOrder])
  @@map("payment_allocations")
}

model PaymentReceipt {
  id             String   @id @default(uuid())
  paymentId      String   @unique
  receiptNumber  String   @unique
  filePath       String?  // Chemin du PDF généré
  verificationToken String? @unique // Token pour vérification publique QR Code
  verificationTokenHash String? @unique // Hash du token pour recherche
  issuedAt       DateTime @default(now())
  issuedBy       String?
  isDuplicate    Boolean  @default(false) // Si réimpression
  duplicateOf    String?  // ID du reçu original si c'est un duplicata
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  issuer  User?   @relation("PaymentReceiptIssuer", fields: [issuedBy], references: [id], onDelete: SetNull)
  originalReceipt PaymentReceipt? @relation("ReceiptDuplicate", fields: [duplicateOf], references: [id], onDelete: SetNull)
  duplicates PaymentReceipt[] @relation("ReceiptDuplicate")

  notifications PaymentNotification[]

  @@index([receiptNumber])
  @@index([verificationTokenHash])
  @@map("payment_receipts")
}

/**
 * Notifications de reçus envoyées aux parents (SMS + WhatsApp)
 * Traçabilité complète pour preuve légale
 */
model PaymentNotification {
  id             String   @id @default(uuid())
  paymentId      String
  receiptId      String
  channel        String   // SMS | WHATSAPP
  recipientPhone String
  messageSnapshot String // Message envoyé (preuve légale)
  attachmentUrl  String?  // URL de l'image du reçu (WhatsApp)
  status         String   @default("PENDING") // PENDING | SENT | FAILED
  sentAt         DateTime?
  errorMessage   String?
  metadata       Json?    // Détails d'envoi (provider, cost, etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  receipt PaymentReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([receiptId])
  @@index([channel])
  @@index([status])
  @@index([sentAt])
  @@map("payment_notifications")
}

// ----------------------------------------------------------------------------
// CONTRÔLE DE SCOLARITÉ
// ----------------------------------------------------------------------------

model PaymentSummary {
  id             String   @id @default(uuid())
  tenantId       String
  studentId      String
  academicYearId String
  studentFeeId   String   @unique
  expectedAmount Decimal  @db.Decimal(10, 2)
  paidAmount     Decimal  @default(0) @db.Decimal(10, 2)
  balance        Decimal  @default(0) @db.Decimal(10, 2)
  lastPaymentDate DateTime?
  updatedAt      DateTime @updatedAt

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  studentFee  StudentFee  @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)

  @@unique([studentId, academicYearId, studentFeeId])
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@map("payment_summaries")
}

// ----------------------------------------------------------------------------
// TRÉSORERIE & CLÔTURES
// ----------------------------------------------------------------------------

model DailyClosure {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  schoolLevelId  String
  date           DateTime @db.Date
  totalCollected Decimal  @default(0) @db.Decimal(10, 2)
  totalSpent     Decimal  @default(0) @db.Decimal(10, 2)
  openingBalance Decimal  @default(0) @db.Decimal(10, 2)
  closingBalance Decimal  @default(0) @db.Decimal(10, 2)
  discrepancy    Decimal? @db.Decimal(10, 2)
  validated      Boolean  @default(false)
  validatedBy    String?
  validatedAt    DateTime?
  notes          String?
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Restrict)
  validator    User?        @relation("DailyClosureValidator", fields: [validatedBy], references: [id], onDelete: SetNull)
  creator      User?        @relation("DailyClosureCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@unique([tenantId, academicYearId, schoolLevelId, date])
  @@index([tenantId, academicYearId, schoolLevelId])
  @@index([date])
  @@map("daily_closures")
}

// ----------------------------------------------------------------------------
// SOUS-MODULE RECOUVREMENT
// ----------------------------------------------------------------------------

model FeeArrear {
  id             String   @id @default(uuid())
  tenantId       String
  academicYearId String
  studentId      String
  studentFeeId   String
  totalDue       Decimal  @db.Decimal(10, 2)
  totalPaid      Decimal  @default(0) @db.Decimal(10, 2)
  balanceDue     Decimal  @db.Decimal(10, 2)
  arrearsLevel   String   @default("LOW") // LOW | MEDIUM | HIGH | CRITICAL
  lastPaymentDate DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentFee   StudentFee   @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  reminders    CollectionReminder[]
  promises     PaymentPromise[]
  actions      CollectionAction[]

  @@unique([studentId, studentFeeId, academicYearId])
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@index([arrearsLevel])
  @@map("fee_arrears")
}

model CollectionReminder {
  id             String   @id @default(uuid())
  feeArrearId    String
  channel        String   // SMS | EMAIL | WHATSAPP | PUSH
  reminderStage  String   // J3 | J7 | J15 | J30
  sentAt         DateTime @default(now())
  status         String   @default("SENT") // SENT | FAILED
  message        String?
  metadata       Json?    // Détails d'envoi (provider, cost, etc.)
  createdAt      DateTime @default(now())

  feeArrear FeeArrear @relation(fields: [feeArrearId], references: [id], onDelete: Cascade)

  @@index([feeArrearId])
  @@index([status])
  @@index([sentAt])
  @@map("collection_reminders")
}

model PaymentPromise {
  id             String   @id @default(uuid())
  feeArrearId    String
  promisedAmount Decimal  @db.Decimal(10, 2)
  promisedDate   DateTime @db.Date
  status         String   @default("PENDING") // PENDING | HONORED | BROKEN
  notes          String?
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  feeArrear FeeArrear @relation(fields: [feeArrearId], references: [id], onDelete: Cascade)
  creator   User?     @relation("PaymentPromiseCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([feeArrearId])
  @@index([status])
  @@index([promisedDate])
  @@map("payment_promises")
}

model CollectionAction {
  id             String   @id @default(uuid())
  feeArrearId    String?
  collectionCaseId String?
  actionType     String   // REMINDER | WARNING | BLOCK | CALL | MEETING | SUSPENSION | OTHER
  channel        String?  // SMS | WHATSAPP | INTERNAL | EMAIL
  message        String?  // Message snapshot
  notes          String?
  performedBy    String?
  performedAt    DateTime @default(now())
  createdAt      DateTime @default(now())

  feeArrear FeeArrear? @relation(fields: [feeArrearId], references: [id], onDelete: Cascade)
  collectionCase CollectionCase? @relation(fields: [collectionCaseId], references: [id], onDelete: Cascade)
  performer User?     @relation("CollectionActionPerformer", fields: [performedBy], references: [id], onDelete: SetNull)

  @@index([feeArrearId])
  @@index([collectionCaseId])
  @@index([actionType])
  @@index([performedAt])
  @@map("collection_actions")
}

/**
 * Dossier de recouvrement par élève / année scolaire
 * Vue synthétique de tous les impayés d'un élève
 */
model CollectionCase {
  id              String   @id @default(uuid())
  tenantId        String
  studentId       String
  academicYearId  String
  totalDue        Decimal  @db.Decimal(10, 2) // Total dû pour l'année
  totalPaid       Decimal  @default(0) @db.Decimal(10, 2) // Total payé
  outstandingAmount Decimal @db.Decimal(10, 2) // Solde restant
  status          String   @default("ON_TIME") // ON_TIME | LATE | CRITICAL | BLOCKED
  escalationLevel Int      @default(0) // 0 = aucune escalade, 1-4 = niveaux d'escalade
  lastActionAt    DateTime?
  blockedUntil    DateTime? // Date jusqu'à laquelle le blocage est actif
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student      Student      @relation("StudentCollectionCase", fields: [studentId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation("CollectionCaseAcademicYear", fields: [academicYearId], references: [id], onDelete: Restrict)
  actions      CollectionAction[]

  @@unique([studentId, academicYearId])
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@index([status])
  @@map("collection_cases")
}

// ============================================================================
// MODULE 9 — MODULES COMPLÉMENTAIRES
// ============================================================================

// ----------------------------------------------------------------------------
// 9.1 CANTINE SCOLAIRE
// ----------------------------------------------------------------------------

/**
 * Menus de la cantine par semaine
 */
model CanteenMenu {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  weekNumber    Int      // Numéro de semaine (1-52)
  weekStartDate DateTime @db.Date
  weekEndDate   DateTime @db.Date
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  meals        CanteenMeal[]

  @@unique([tenantId, academicYearId, weekNumber])
  @@index([tenantId, academicYearId])
  @@index([weekStartDate, weekEndDate])
  @@map("canteen_menus")
}

/**
 * Repas individuels dans un menu
 */
model CanteenMeal {
  id          String   @id @default(uuid())
  menuId      String
  dayOfWeek   Int      // 0=Dimanche, 1=Lundi, ..., 6=Samedi
  mealType    String   // BREAKFAST | LUNCH | SNACK | DINNER
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  menu CanteenMenu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId])
  @@index([dayOfWeek, mealType])
  @@map("canteen_meals")
}

/**
 * Inscriptions des élèves à la cantine
 */
model CanteenEnrollment {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  studentId     String
  schoolLevelId String?
  classId       String?
  startDate     DateTime @db.Date
  endDate       DateTime? @db.Date
  mealTypes     String[] // ["BREAKFAST", "LUNCH", "SNACK", "DINNER"]
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schoolLevel  SchoolLevel? @relation("CanteenEnrollmentSchoolLevel", fields: [schoolLevelId], references: [id], onDelete: SetNull)
  class        Class?       @relation("CanteenEnrollmentClass", fields: [classId], references: [id], onDelete: SetNull)
  attendances  CanteenAttendance[]
  allergies    CanteenAllergy[]

  @@unique([tenantId, academicYearId, studentId])
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@index([isActive])
  @@map("canteen_enrollments")
}

/**
 * Présences aux repas
 */
model CanteenAttendance {
  id           String   @id @default(uuid())
  enrollmentId String
  mealDate     DateTime @db.Date
  mealType     String   // BREAKFAST | LUNCH | SNACK | DINNER
  status       String   @default("PRESENT") // PRESENT | ABSENT | EXCUSED
  notes        String?
  recordedBy   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  enrollment CanteenEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  recorder   User?             @relation("CanteenAttendanceRecorder", fields: [recordedBy], references: [id], onDelete: SetNull)

  @@unique([enrollmentId, mealDate, mealType])
  @@index([enrollmentId])
  @@index([mealDate])
  @@index([status])
  @@map("canteen_attendances")
}

/**
 * Allergies alimentaires des élèves
 */
model CanteenAllergy {
  id           String   @id @default(uuid())
  enrollmentId String
  allergen     String   // Nom de l'allergène
  severity     String   @default("MODERATE") // MILD | MODERATE | SEVERE
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  enrollment CanteenEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([allergen])
  @@map("canteen_allergies")
}

// ----------------------------------------------------------------------------
// 9.2 TRANSPORT SCOLAIRE
// ----------------------------------------------------------------------------

/**
 * Véhicules de transport
 */
model Vehicle {
  id              String   @id @default(uuid())
  tenantId        String
  academicYearId  String
  vehicleType     String   // BUS | VAN | CAR
  plateNumber     String
  capacity        Int      // Nombre de places
  driverId        String?  // ID du conducteur (Staff)
  status          String   @default("ACTIVE") // ACTIVE | MAINTENANCE | OUT_OF_SERVICE
  lastMaintenance DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  routes       Route[]
  assignments  TransportAssignment[]
  incidents    TransportIncident[]

  @@unique([tenantId, academicYearId, plateNumber])
  @@index([tenantId, academicYearId])
  @@index([status])
  @@map("vehicles")
}

/**
 * Itinéraires de transport
 */
model Route {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  vehicleId     String
  name          String
  description   String?
  startTime     String   // Format HH:mm
  endTime       String?  // Format HH:mm
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  vehicle      Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  stops        RouteStop[]
  assignments  TransportAssignment[]
  incidents    TransportIncident[]

  @@index([tenantId, academicYearId])
  @@index([vehicleId])
  @@index([isActive])
  @@map("routes")
}

/**
 * Arrêts d'un itinéraire
 */
model RouteStop {
  id          String   @id @default(uuid())
  routeId     String
  stopOrder   Int      // Ordre de l'arrêt (1, 2, 3...)
  name        String
  address     String?
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  arrivalTime String?  // Format HH:mm
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)
  assignments TransportAssignment[]

  @@index([routeId])
  @@index([routeId, stopOrder])
  @@map("route_stops")
}

/**
 * Affectations élèves-itinéraires
 */
model TransportAssignment {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  studentId     String
  routeId       String
  vehicleId     String
  stopId        String?  // Arrêt de prise en charge
  startDate     DateTime @db.Date
  endDate       DateTime? @db.Date
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  route        Route        @relation(fields: [routeId], references: [id], onDelete: Restrict)
  vehicle      Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  stop         RouteStop?   @relation(fields: [stopId], references: [id], onDelete: SetNull)
  attendances  TransportAttendance[]

  @@unique([tenantId, academicYearId, studentId])
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@index([routeId])
  @@index([vehicleId])
  @@index([isActive])
  @@map("transport_assignments")
}

/**
 * Présences au transport
 */
model TransportAttendance {
  id            String   @id @default(uuid())
  assignmentId  String
  attendanceDate DateTime @db.Date
  direction     String   // MORNING | EVENING
  status        String   @default("PRESENT") // PRESENT | ABSENT | EXCUSED
  notes         String?
  recordedBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  assignment TransportAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  recorder   User?               @relation("TransportAttendanceRecorder", fields: [recordedBy], references: [id], onDelete: SetNull)

  @@unique([assignmentId, attendanceDate, direction])
  @@index([assignmentId])
  @@index([attendanceDate])
  @@index([status])
  @@map("transport_attendances")
}

/**
 * Incidents de transport
 */
model TransportIncident {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  vehicleId     String?
  routeId       String?
  incidentDate  DateTime @db.Date
  incidentType  String   // ACCIDENT | BREAKDOWN | DELAY | OTHER
  severity      String   @default("MEDIUM") // LOW | MEDIUM | HIGH | CRITICAL
  description   String
  affectedStudents Int?  // Nombre d'élèves affectés
  resolved      Boolean  @default(false)
  resolvedAt    DateTime?
  reportedBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  vehicle     Vehicle?     @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  route       Route?       @relation(fields: [routeId], references: [id], onDelete: SetNull)
  reporter    User?        @relation("TransportIncidentReporter", fields: [reportedBy], references: [id], onDelete: SetNull)

  @@index([tenantId, academicYearId])
  @@index([vehicleId])
  @@index([routeId])
  @@index([incidentDate])
  @@index([severity])
  @@index([resolved])
  @@map("transport_incidents")
}

// ----------------------------------------------------------------------------
// 9.3 BIBLIOTHÈQUE
// ----------------------------------------------------------------------------

/**
 * Ouvrages de la bibliothèque
 */
model LibraryBook {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  isbn          String?
  title         String
  author        String?
  publisher     String?
  publicationYear Int?
  category      String?
  language      String   @default("FR")
  totalCopies   Int      @default(1)
  availableCopies Int    @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  copies       LibraryCopy[]
  loans        LibraryLoan[]

  @@index([tenantId, academicYearId])
  @@index([isbn])
  @@index([title])
  @@index([author])
  @@index([category])
  @@map("library_books")
}

/**
 * Exemplaires individuels d'un ouvrage
 */
model LibraryCopy {
  id          String   @id @default(uuid())
  bookId      String
  copyNumber  String   // Numéro d'exemplaire (ex: "EX-001")
  barcode     String?  // Code-barres unique
  status      String   @default("AVAILABLE") // AVAILABLE | LOANED | RESERVED | MAINTENANCE | LOST
  condition   String   @default("GOOD") // EXCELLENT | GOOD | FAIR | POOR
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  book  LibraryBook @relation(fields: [bookId], references: [id], onDelete: Cascade)
  loans LibraryLoan[]

  @@unique([bookId, copyNumber])
  @@index([bookId])
  @@index([barcode])
  @@index([status])
  @@map("library_copies")
}

/**
 * Emprunts
 */
model LibraryLoan {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  bookId        String
  copyId        String
  studentId     String
  loanDate      DateTime @db.Date
  dueDate       DateTime @db.Date
  returnDate    DateTime? @db.Date
  status        String   @default("ACTIVE") // ACTIVE | RETURNED | OVERDUE | LOST
  notes         String?
  loanedBy      String?
  returnedBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  book         LibraryBook  @relation(fields: [bookId], references: [id], onDelete: Restrict)
  copy         LibraryCopy  @relation(fields: [copyId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  loaner       User?        @relation("LibraryLoanLoaner", fields: [loanedBy], references: [id], onDelete: SetNull)
  returner     User?        @relation("LibraryLoanReturner", fields: [returnedBy], references: [id], onDelete: SetNull)
  penalties    LibraryPenalty[]

  @@index([tenantId, academicYearId])
  @@index([bookId])
  @@index([copyId])
  @@index([studentId])
  @@index([loanDate])
  @@index([dueDate])
  @@index([status])
  @@map("library_loans")
}

/**
 * Pénalités pour retards
 */
model LibraryPenalty {
  id            String   @id @default(uuid())
  loanId        String
  penaltyDate   DateTime @db.Date
  penaltyType   String   @default("LATE_RETURN") // LATE_RETURN | DAMAGE | LOSS
  amount        Decimal  @db.Decimal(10, 2)
  description   String?
  paid          Boolean  @default(false)
  paidAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  loan LibraryLoan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId])
  @@index([penaltyDate])
  @@index([paid])
  @@map("library_penalties")
}

// ----------------------------------------------------------------------------
// 9.4 LABORATOIRES
// ----------------------------------------------------------------------------

/**
 * Laboratoires
 */
model Lab {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  name          String
  description   String?
  location      String?
  capacity      Int?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  equipment    LabEquipment[]
  reservations LabReservation[]

  @@unique([tenantId, academicYearId, name])
  @@index([tenantId, academicYearId])
  @@index([isActive])
  @@map("labs")
}

/**
 * Équipements de laboratoire
 */
model LabEquipment {
  id            String   @id @default(uuid())
  labId         String
  name          String
  equipmentType String   // EQUIPMENT | MATERIAL | TOOL
  manufacturer  String?
  model         String?
  serialNumber  String?
  quantity      Int      @default(1)
  condition     String   @default("GOOD") // EXCELLENT | GOOD | FAIR | POOR | OUT_OF_ORDER
  lastMaintenance DateTime?
  nextMaintenance DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lab         Lab              @relation(fields: [labId], references: [id], onDelete: Cascade)
  maintenance LabMaintenance[]
  incidents   LabIncident[]

  @@index([labId])
  @@index([equipmentType])
  @@index([condition])
  @@map("lab_equipment")
}

/**
 * Réservations de laboratoire
 */
model LabReservation {
  id            String   @id @default(uuid())
  labId         String
  reservedBy    String?  // User (enseignant)
  reservationDate DateTime @db.Date
  startTime     String   // Format HH:mm
  endTime       String   // Format HH:mm
  purpose       String?
  status        String   @default("CONFIRMED") // CONFIRMED | CANCELLED | COMPLETED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lab  Lab  @relation(fields: [labId], references: [id], onDelete: Cascade)
  user User? @relation("LabReservationUser", fields: [reservedBy], references: [id], onDelete: SetNull)

  @@index([labId])
  @@index([reservationDate])
  @@index([status])
  @@map("lab_reservations")
}

/**
 * Maintenance des équipements
 */
model LabMaintenance {
  id            String   @id @default(uuid())
  equipmentId   String
  maintenanceDate DateTime @db.Date
  maintenanceType String   // PREVENTIVE | REPAIR | CALIBRATION | INSPECTION
  description   String?
  cost          Decimal? @db.Decimal(10, 2)
  performedBy   String?  // User ou fournisseur externe
  nextMaintenance DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  equipment LabEquipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([maintenanceDate])
  @@map("lab_maintenance")
}

/**
 * Incidents de laboratoire
 */
model LabIncident {
  id            String   @id @default(uuid())
  equipmentId   String
  incidentDate  DateTime @db.Date
  incidentType  String   // DAMAGE | BREAKDOWN | ACCIDENT | THEFT
  severity      String   @default("MEDIUM") // LOW | MEDIUM | HIGH | CRITICAL
  description   String
  resolved      Boolean  @default(false)
  resolvedAt    DateTime?
  reportedBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  equipment LabEquipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  reporter  User?        @relation("LabIncidentReporter", fields: [reportedBy], references: [id], onDelete: SetNull)

  @@index([equipmentId])
  @@index([incidentDate])
  @@index([severity])
  @@index([resolved])
  @@map("lab_incidents")
}

// ----------------------------------------------------------------------------
// 9.5 INFIRMERIE
// ----------------------------------------------------------------------------

/**
 * Dossiers médicaux des élèves
 */
model MedicalRecord {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  studentId     String
  bloodType     String?
  allergies     String[] // Liste des allergies
  chronicConditions String[] // Maladies chroniques
  medications   String[] // Médicaments en cours
  emergencyContact String? // Contact d'urgence
  emergencyPhone   String? // Téléphone d'urgence
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  visits       MedicalVisit[]
  alerts       MedicalAlert[]

  @@unique([tenantId, academicYearId, studentId])
  @@index([tenantId, academicYearId])
  @@index([studentId])
  @@map("medical_records")
}

/**
 * Consultations médicales
 */
model MedicalVisit {
  id            String   @id @default(uuid())
  recordId      String
  visitDate     DateTime @db.Date
  visitTime     String?  // Format HH:mm
  reason        String   // Raison de la visite
  diagnosis     String?
  treatment     String?
  medicationId  String?  // Si médicament prescrit
  temperature   Decimal? @db.Decimal(4, 2)
  bloodPressure String?
  notes         String?
  performedBy   String?  // User (infirmier/infirmière)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  record     MedicalRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  medication Medication?   @relation(fields: [medicationId], references: [id], onDelete: SetNull)
  performer  User?         @relation("MedicalVisitPerformer", fields: [performedBy], references: [id], onDelete: SetNull)

  @@index([recordId])
  @@index([visitDate])
  @@map("medical_visits")
}

/**
 * Médicaments administrés
 */
model Medication {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  name          String
  dosage        String?
  form          String?  // TABLET | SYRUP | INJECTION | etc.
  quantity      Int      @default(1)
  expiryDate    DateTime? @db.Date
  stockLevel    Int      @default(0)
  isPrescription Boolean @default(false) // Médicament sur ordonnance
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  visits       MedicalVisit[]

  @@index([tenantId, academicYearId])
  @@index([name])
  @@index([expiryDate])
  @@map("medications")
}

/**
 * Alertes santé
 */
model MedicalAlert {
  id            String   @id @default(uuid())
  recordId      String
  alertType     String   // ALLERGY | CONDITION | MEDICATION | EMERGENCY
  severity      String   @default("MEDIUM") // LOW | MEDIUM | HIGH | CRITICAL
  title         String
  description   String
  isActive      Boolean  @default(true)
  acknowledged  Boolean  @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  record      MedicalRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  acknowledger User?        @relation("MedicalAlertAcknowledger", fields: [acknowledgedBy], references: [id], onDelete: SetNull)

  @@index([recordId])
  @@index([alertType])
  @@index([severity])
  @@index([isActive])
  @@map("medical_alerts")
}

// ----------------------------------------------------------------------------
// 9.6 BOUTIQUE SCOLAIRE
// ----------------------------------------------------------------------------

/**
 * Produits de la boutique
 */
model ShopProduct {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  code          String   // Code produit (ex: "UNIF-001")
  name          String
  description   String?
  category      String?  // UNIFORM | SUPPLIES | BOOKS | OTHER
  unitPrice     Decimal  @db.Decimal(10, 2)
  costPrice     Decimal? @db.Decimal(10, 2) // Prix de revient
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  stock        ShopStock?
  saleItems    ShopSaleItem[]

  @@unique([tenantId, academicYearId, code])
  @@index([tenantId, academicYearId])
  @@index([category])
  @@index([isActive])
  @@map("shop_products")
}

/**
 * Stock des produits
 */
model ShopStock {
  id            String   @id @default(uuid())
  productId     String   @unique
  quantity      Int      @default(0)
  minThreshold  Int      @default(10) // Seuil minimum
  maxThreshold  Int?     // Seuil maximum
  lastRestocked DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  product ShopProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([quantity])
  @@map("shop_stock")
}

/**
 * Ventes
 */
model ShopSale {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  saleNumber    String   // Numéro de vente (ex: "SALE-2024-001")
  saleDate      DateTime @db.Date
  customerType  String   // STUDENT | STAFF | EXTERNAL
  customerId    String?  // ID de l'élève/staff si applicable
  customerName  String?  // Nom si client externe
  totalAmount   Decimal  @db.Decimal(10, 2)
  paymentStatus String   @default("PENDING") // PENDING | PAID | PARTIAL | CANCELLED
  paymentMethod String?  // CASH | CARD | TRANSFER | CHECK
  notes         String?
  soldBy        String?  // User
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  seller       User?           @relation("ShopSaleSeller", fields: [soldBy], references: [id], onDelete: SetNull)
  items        ShopSaleItem[]

  @@unique([tenantId, academicYearId, saleNumber])
  @@index([tenantId, academicYearId])
  @@index([saleDate])
  @@index([paymentStatus])
  @@map("shop_sales")
}

/**
 * Articles d'une vente
 */
model ShopSaleItem {
  id            String   @id @default(uuid())
  saleId        String
  productId     String
  quantity      Int      @default(1)
  unitPrice     Decimal  @db.Decimal(10, 2)
  totalPrice    Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())

  sale    ShopSale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product ShopProduct @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([saleId])
  @@index([productId])
  @@map("shop_sale_items")
}

// ----------------------------------------------------------------------------
// 9.7 EDUCAST (CONTENU & DIFFUSION)
// ----------------------------------------------------------------------------

/**
 * Contenus pédagogiques
 */
model EducastContent {
  id            String   @id @default(uuid())
  tenantId      String
  academicYearId String
  title         String
  description   String?
  contentType   String   // VIDEO | AUDIO | PDF | DOCUMENT | LINK
  filePath      String?  // Chemin du fichier (si upload)
  url           String?  // URL (si lien externe)
  duration      Int?     // Durée en secondes (vidéo/audio)
  fileSize      Int?     // Taille en bytes
  thumbnailPath String?  // Miniature
  schoolLevelId String?  // Restriction par niveau
  classId       String?  // Restriction par classe
  isPublic      Boolean  @default(false) // Public pour tout le niveau ou privé
  isActive      Boolean  @default(true)
  uploadedBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  academicYear AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolLevel  SchoolLevel?    @relation("EducastContentSchoolLevel", fields: [schoolLevelId], references: [id], onDelete: SetNull)
  class        Class?          @relation("EducastContentClass", fields: [classId], references: [id], onDelete: SetNull)
  uploader     User?           @relation("EducastContentUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)
  accesses     EducastAccess[]
  sessions     EducastSession[]

  @@index([tenantId, academicYearId])
  @@index([contentType])
  @@index([schoolLevelId])
  @@index([classId])
  @@index([isActive])
  @@map("educast_contents")
}

/**
 * Accès aux contenus
 */
model EducastAccess {
  id            String   @id @default(uuid())
  contentId     String
  studentId     String?  // Si accès individuel
  schoolLevelId String?  // Si accès par niveau
  classId       String?  // Si accès par classe
  accessType    String   // STUDENT | LEVEL | CLASS | ALL
  grantedAt     DateTime @default(now())
  grantedBy     String?
  expiresAt     DateTime? // Date d'expiration de l'accès
  createdAt     DateTime @default(now())

  content     EducastContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  student     Student?       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schoolLevel SchoolLevel?   @relation("EducastAccessSchoolLevel", fields: [schoolLevelId], references: [id], onDelete: Cascade)
  class       Class?         @relation("EducastAccessClass", fields: [classId], references: [id], onDelete: Cascade)
  granter     User?          @relation("EducastAccessGranter", fields: [grantedBy], references: [id], onDelete: SetNull)

  @@index([contentId])
  @@index([studentId])
  @@index([schoolLevelId])
  @@index([classId])
  @@index([accessType])
  @@map("educast_accesses")
}

/**
 * Sessions de visionnage/consultation
 */
model EducastSession {
  id            String   @id @default(uuid())
  contentId     String
  studentId     String
  startTime     DateTime @default(now())
  endTime       DateTime?
  duration      Int?     // Durée en secondes
  progress      Int?     // Pourcentage de progression (0-100)
  completed     Boolean  @default(false)
  deviceType    String?  // DESKTOP | MOBILE | TABLET
  createdAt     DateTime @default(now())

  content EducastContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  student Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([studentId])
  @@index([startTime])
  @@index([completed])
  @@map("educast_sessions")
}
