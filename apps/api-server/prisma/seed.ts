/**
 * ============================================================================
 * PRISMA SEED - DONNÃ‰ES INITIALES ACADEMIA HUB
 * ============================================================================
 * 
 * Script de seed pour crÃ©er les donnÃ©es initiales indispensables :
 * - Pays BJ (BÃ©nin)
 * - Tenant par dÃ©faut (nÃ©cessaire pour les autres donnÃ©es)
 * - AnnÃ©e scolaire active (2024-2025)
 * - Niveaux scolaires (Maternelle, Primaire, Secondaire)
 * - RÃ©gimes tarifaires STANDARD par niveau
 * 
 * âš ï¸ IMPORTANT : Seed idempotent (peut Ãªtre relancÃ© plusieurs fois)
 * 
 * Usage: npx prisma db seed
 * 
 * ============================================================================
 */

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('ðŸŒ± DÃ©marrage du seed...\n');

  // ============================================================================
  // 1. CRÃ‰ER LE PAYS BJ (BÃ‰NIN) - IDEMPOTENT
  // ============================================================================
  console.log('1ï¸âƒ£  CrÃ©ation du pays BJ (BÃ©nin)...');
  
  const country = await prisma.country.upsert({
    where: { code: 'BJ' },
    update: {},
    create: {
      code: 'BJ',
      name: 'BÃ©nin',
      code3: 'BEN',
      numericCode: '204',
      currencyCode: 'XOF',
      currencySymbol: 'CFA',
      phonePrefix: '+229',
      flagEmoji: 'ðŸ‡§ðŸ‡¯',
      isDefault: true,
      isActive: true,
    },
  });

  console.log(`   âœ… Pays crÃ©Ã©: ${country.name} (${country.code})`);

  // ============================================================================
  // 2. CRÃ‰ER UN TENANT PAR DÃ‰FAUT - IDEMPOTENT
  // ============================================================================
  // âš ï¸ NÃ©cessaire car AcademicYear, SchoolLevel, et FeeRegime nÃ©cessitent un tenantId
  console.log('\n2ï¸âƒ£  CrÃ©ation du tenant par dÃ©faut...');
  
  const tenant = await prisma.tenant.upsert({
    where: { slug: 'default-tenant' },
    update: {},
    create: {
      name: 'Tenant par DÃ©faut - Academia Hub',
      slug: 'default-tenant',
      subdomain: 'default',
      countryId: country.id,
      type: 'SCHOOL',
      subscriptionStatus: 'TRIAL',
      status: 'active',
      subscriptionPlan: 'free',
    },
  });

  console.log(`   âœ… Tenant crÃ©Ã©: ${tenant.name} (${tenant.slug})`);

  // ============================================================================
  // 3. CRÃ‰ER L'ANNÃ‰E SCOLAIRE ACTIVE (2024-2025) - IDEMPOTENT
  // ============================================================================
  console.log('\n3ï¸âƒ£  CrÃ©ation de l\'annÃ©e scolaire active (2024-2025)...');
  
  // Dates : Septembre 2024 - Juillet 2025
  const currentYear = new Date().getFullYear();
  const academicYearName = `${currentYear}-${currentYear + 1}`;
  const startDate = new Date(`${currentYear}-09-01`);
  const endDate = new Date(`${currentYear + 1}-07-31`);
  const preEntryDate = new Date(`${currentYear}-09-02`); // Lundi 2Ã¨me semaine septembre

  // VÃ©rifier si l'annÃ©e existe dÃ©jÃ 
  let academicYear = await prisma.academicYear.findFirst({
    where: {
      tenantId: tenant.id,
      name: academicYearName,
    },
  });

  if (!academicYear) {
    academicYear = await prisma.academicYear.create({
      data: {
        tenantId: tenant.id,
        name: academicYearName,
        label: `AnnÃ©e scolaire ${academicYearName}`,
        startDate: startDate,
        endDate: endDate,
        preEntryDate: preEntryDate,
        isActive: true,
        isAutoGenerated: false,
      },
    });
    console.log(`   âœ… AnnÃ©e scolaire crÃ©Ã©e: ${academicYear.label}`);
  } else {
    // Mettre Ã  jour si elle existe mais n'est pas active
    if (!academicYear.isActive) {
      academicYear = await prisma.academicYear.update({
        where: { id: academicYear.id },
        data: { isActive: true },
      });
      console.log(`   âœ… AnnÃ©e scolaire activÃ©e: ${academicYear.label}`);
    } else {
      console.log(`   â„¹ï¸  AnnÃ©e scolaire dÃ©jÃ  existante: ${academicYear.label}`);
    }
  }

  // ============================================================================
  // 4. CRÃ‰ER LES NIVEAUX SCOLAIRES - IDEMPOTENT
  // ============================================================================
  console.log('\n4ï¸âƒ£  CrÃ©ation des niveaux scolaires...');

  const schoolLevelsData = [
    { code: 'MATERNELLE', name: 'Maternelle', label: 'Maternelle', order: 1 },
    { code: 'PRIMAIRE', name: 'Primaire', label: 'Primaire', order: 2 },
    { code: 'SECONDAIRE', name: 'Secondaire', label: 'Secondaire', order: 3 },
  ];

  const schoolLevels = [];

  for (const levelData of schoolLevelsData) {
    // Utiliser upsert avec la contrainte unique (tenantId, code)
    const schoolLevel = await prisma.schoolLevel.upsert({
      where: {
        tenantId_code: {
          tenantId: tenant.id,
          code: levelData.code,
        },
      },
      update: {},
      create: {
        tenantId: tenant.id,
        code: levelData.code,
        name: levelData.name,
        label: levelData.label,
        order: levelData.order,
      },
    });

    schoolLevels.push(schoolLevel);
    console.log(`   âœ… Niveau crÃ©Ã©: ${schoolLevel.label} (${schoolLevel.code})`);
  }

  // ============================================================================
  // 5. CRÃ‰ER LES RÃ‰GIMES TARIFAIRES STANDARD - IDEMPOTENT
  // ============================================================================
  console.log('\n5ï¸âƒ£  CrÃ©ation des rÃ©gimes tarifaires STANDARD...');

  for (const schoolLevel of schoolLevels) {
    // VÃ©rifier si le rÃ©gime STANDARD existe dÃ©jÃ  pour cette combinaison
    const existingRegime = await prisma.feeRegime.findFirst({
      where: {
        tenantId: tenant.id,
        academicYearId: academicYear.id,
        schoolLevelId: schoolLevel.id,
        code: 'STANDARD',
      },
    });

    if (!existingRegime) {
      const feeRegime = await prisma.feeRegime.create({
        data: {
          tenantId: tenant.id,
          academicYearId: academicYear.id,
          schoolLevelId: schoolLevel.id,
          code: 'STANDARD',
          label: `RÃ©gime STANDARD - ${schoolLevel.label}`,
          description: `RÃ©gime tarifaire standard pour le niveau ${schoolLevel.label}`,
          isDefault: true,
        },
      });

      console.log(`   âœ… RÃ©gime STANDARD crÃ©Ã© pour ${schoolLevel.label}`);
    } else {
      console.log(`   â„¹ï¸  RÃ©gime STANDARD dÃ©jÃ  existant pour ${schoolLevel.label}`);
    }
  }

  // ============================================================================
  // RÃ‰SUMÃ‰
  // ============================================================================
  console.log('\n' + '='.repeat(60));
  console.log('âœ… Seed terminÃ© avec succÃ¨s!');
  console.log('='.repeat(60));
  console.log('\nðŸ“Š DonnÃ©es crÃ©Ã©es:');
  console.log(`   - Pays: ${country.name} (${country.code})`);
  console.log(`   - Tenant: ${tenant.name}`);
  console.log(`   - AnnÃ©e scolaire: ${academicYear.label}`);
  console.log(`   - Niveaux scolaires: ${schoolLevels.length} (${schoolLevels.map(s => s.label).join(', ')})`);
  console.log(`   - RÃ©gimes tarifaires: ${schoolLevels.length} (STANDARD par niveau)`);
  console.log('\nðŸŽ¯ La base de donnÃ©es est prÃªte Ã  l\'usage!');
}

main()
  .catch((e) => {
    console.error('\nâŒ Erreur lors du seed:');
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
